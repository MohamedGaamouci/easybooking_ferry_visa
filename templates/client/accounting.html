{% extends 'client/base_client.html' %}
{% load humanize %}

{% block content %}

<main class="max-w-7xl mx-auto px-6 pt-24 pb-12 fade-in" x-data="{ tab: 'invoices', showFilters: false }">
    <input type="hidden" id="apiUrl" value="{% url 'finance:api_router' %}">
    <input type="hidden" id="activeTabValue" :value="tab">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

        <div
            class="md:col-span-1 bg-gradient-to-br from-slate-900 to-brand-900 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden group">
            <div
                class="absolute -top-12 -right-12 p-6 opacity-10 group-hover:opacity-20 transition-opacity duration-500 transform group-hover:scale-110">
                <i class="ph-fill ph-wallet text-9xl"></i>
            </div>

            <div class="relative z-10 flex flex-col h-full justify-between">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <p class="text-slate-300 text-xs font-bold uppercase tracking-wider">Available Balance</p>
                    </div>
                    <h2 class="text-4xl font-bold tracking-tight text-white mb-1" id="display-balance">
                        {{stats.cash_balance|intcomma }} <span class="text-lg text-slate-400 font-medium">DZD</span>
                    </h2>
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-white/10">
                    <div>
                        <span class="block text-slate-400 text-xs mb-0.5">Buying Power</span>
                        <span class="font-bold text-white text-lg">{{ stats.buying_power|intcomma }}</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-slate-400 text-xs mb-0.5">Held Amount</span>
                        <span class="font-bold text-yellow-400 text-lg">{{ stats.reserved_amount|intcomma }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div
            class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300 flex flex-col justify-between relative overflow-hidden">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Spend</p>
                    <h3 class="text-3xl font-bold text-slate-900">{{ stats.total_spent|intcomma }} <span
                            class="text-sm text-slate-400 font-medium">DZD</span></h3>
                </div>
                <div class="w-10 h-10 bg-brand-50 text-brand-600 rounded-xl flex items-center justify-center text-xl">
                    <i class="ph-bold ph-chart-bar"></i>
                </div>
            </div>
            <div class="mt-4">
                {% if stats.unpaid_invoices_count > 0 %}
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-red-50 border border-red-100">
                    <i class="ph-fill ph-warning-circle text-red-500"></i>
                    <span class="text-xs font-bold text-red-700">{{ stats.unpaid_invoices_count }} Unpaid
                        Invoices</span>
                </div>
                {% else %}
                <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-green-50 border border-green-100">
                    <i class="ph-fill ph-check-circle text-green-500"></i>
                    <span class="text-xs font-bold text-green-700">All caught up!</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div
            class="bg-slate-50 border border-slate-200 rounded-2xl p-6 flex flex-col justify-center items-center text-center relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-400 to-brand-600"></div>
            <div
                class="w-12 h-12 bg-white text-brand-600 rounded-full flex items-center justify-center mb-3 text-2xl shadow-sm border border-slate-100">
                <i class="ph-duotone ph-bank"></i>
            </div>
            <h3 class="font-bold text-slate-900 mb-1">Low on funds?</h3>
            <p class="text-xs text-slate-500 mb-5 px-4">Upload a receipt to instantly request a wallet top-up.</p>
            <button onclick="openTopUpModal()"
                class="w-full bg-brand-600 hover:bg-brand-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-brand-600/20 transition-all transform hover:-translate-y-0.5">
                <i class="ph-bold ph-plus mr-1"></i> Request Top-Up
            </button>
        </div>
    </div>

    {% if pending_topups %}
    <div
        class="mb-8 bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3 shadow-sm animate-pulse-slow">
        <div class="mt-0.5 bg-amber-100 p-1.5 rounded-full text-amber-600">
            <i class="ph-fill ph-clock text-lg"></i>
        </div>
        <div>
            <h4 class="text-sm font-bold text-amber-900">Pending Requests</h4>
            <div class="space-y-1 mt-1">
                {% for req in pending_topups %}
                <p class="text-xs text-amber-800">
                    Requesting <span class="font-mono font-bold">{{ req.amount|intcomma }} DZD</span>
                    via {{ req.reference_number|default:"Cash" }}
                    <span class="opacity-60 ml-1">({{ req.created_at|timesince }} ago)</span>
                </p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
        <div class="border-b border-slate-200 bg-slate-50/50 p-3">
            <div class="flex bg-slate-200/50 p-1 rounded-xl w-fit">
                <button @click="tab = 'invoices'"
                    :class="tab === 'invoices' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-500'"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all">Invoices</button>
                <button @click="tab = 'ledger'" @click.once="fetchLedger()"
                    :class="tab === 'ledger' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-500'"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all">History</button>
                <button @click="tab = 'topups'" @click.once="fetchTopups()"
                    :class="tab === 'topups' ? 'bg-white text-brand-700 shadow-sm' : 'text-slate-500'"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all">Topups</button>
            </div>
        </div>

        <div class="relative min-h-[400px]">

            <div x-show="tab === 'invoices'" class="p-4 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:flex lg:items-center gap-3">
                    <div class="relative lg:flex-1">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" id="inv-search" oninput="triggerInvoiceSearch()"
                            placeholder="Search Invoice #..."
                            class="w-full pl-9 pr-4 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-1 focus:ring-brand-500">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:items-center gap-3">
                        <select id="inv-status" onchange="triggerInvoiceSearch()"
                            class="w-full lg:w-44 border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white outline-none">
                            <option value="">All Statuses</option>
                            <option value="unpaid">Unpaid</option>
                            <option value="paid">Paid</option>
                            <option value="refunded">Refunded</option>
                            <option value="cancelled">Cancelled</option>
                        </select>

                        <div
                            class="flex items-center gap-2 bg-white border border-slate-300 rounded-lg px-2 py-1.5 lg:py-1">
                            <input type="date" id="inv-date-from" onchange="triggerInvoiceSearch()"
                                class="w-full text-xs border-none outline-none focus:ring-0 bg-transparent">
                            <span class="text-slate-300 font-bold">/</span>
                            <input type="date" id="inv-date-to" onchange="triggerInvoiceSearch()"
                                class="w-full text-xs border-none outline-none focus:ring-0 bg-transparent">
                        </div>
                    </div>
                </div>

                <div class="border border-slate-200 rounded-xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead
                                class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4">Invoice ID</th>
                                    <th class="px-6 py-4">Created</th>
                                    <th class="px-6 py-4">Total Amount</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                    <th class="px-6 py-4 text-right">Receipt</th>
                                </tr>
                            </thead>
                            <tbody id="inv-body" class="divide-y divide-slate-100 text-sm">
                                {% for invoice in invoices %}
                                <tr onclick="openInvoiceModal({{ invoice.id }})"
                                    class="group hover:bg-slate-50 transition-colors cursor-pointer">
                                    <td class="px-6 py-4"><span
                                            class="font-mono font-bold text-slate-900 bg-slate-100 px-2 py-1 rounded text-xs">
                                            #{{ invoice.invoice_number }}</span></td>
                                    <td class="px-6 py-4 text-slate-500 text-xs font-medium">
                                        {{ invoice.created_at|date:"M d, Y" }}</td>
                                    <td class="px-6 py-4 font-bold text-slate-900 tabular-nums">
                                        {{ invoice.total_amount|intcomma }} <span
                                            class="text-xs text-slate-400 font-normal">DZD</span></td>
                                    <td class="px-6 py-4 text-center">
                                        <span
                                            class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold {% if invoice.status == 'paid' %}bg-green-50 text-green-700{% else %}bg-red-50 text-red-700{% endif %} uppercase">
                                            {{ invoice.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <button class="text-slate-400 hover:text-brand-600 p-2"><i
                                                class="ph-bold ph-download-simple text-lg"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="inv-pagination"
                        class="p-3 border-t border-slate-200 flex justify-between items-center bg-slate-50">
                        <span class="text-xs text-slate-500">Page <span id="inv-current">{{ invoices.number }}</span> of
                            <span id="inv-total">{{ invoices.paginator.num_pages }}</span></span>
                        <div class="flex gap-2">
                            <button {% if not invoices.has_previous %}disabled{% endif %} id="inv-prev"
                                onclick="changeInvoicePage(-1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Prev</button>
                            <button {% if not invoices.has_next %}disabled{% endif %} id="inv-next"
                                onclick="changeInvoicePage(1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="tab === 'ledger'" style="display: none;" class="p-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:items-center gap-3">
                    <div class="relative flex-1 sm:col-span-2 lg:col-span-1">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="text" id="ledger-search" oninput="triggerLedgerSearch()"
                            placeholder="Search descriptions..."
                            class="w-full pl-9 pr-4 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-1 focus:ring-brand-500">
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="date" id="ledger-date-from" onchange="triggerLedgerSearch()"
                            class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                        <span class="text-slate-400">to</span>
                        <input type="date" id="ledger-date-to" onchange="triggerLedgerSearch()"
                            class="flex-1 border border-slate-300 rounded-lg px-2 py-1 text-xs">
                    </div>
                </div>

                <div class="border border-slate-200 rounded-xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[700px]">
                            <thead
                                class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Description</th>
                                    <th class="px-6 py-4">Type</th>
                                    <th class="px-6 py-4 text-right">Amount</th>
                                    <th class="px-6 py-4 text-center">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="ledger-body" class="divide-y divide-slate-100 text-sm">
                                {% for t in transactions %}
                                <tr class="group hover:bg-slate-50 transition-colors">
                                    <td class="px-6 py-4 text-slate-500 whitespace-nowrap">
                                        <span class="font-medium text-slate-700 block">
                                            {{ t.created_at|date:"M d,Y"}}</span>
                                        <span class="text-[10px] text-slate-400">{{ t.created_at|time:"H:i" }}</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-slate-800">{{ t.description }}</div>
                                        <div class="text-xs text-slate-400 font-mono">{% if t.invoice %}Ref:
                                            #{{ t.invoice.invoice_number }}{% endif %}</div>
                                    </td>
                                    <td class="px-6 py-4"><span
                                            class="text-[10px] font-bold bg-slate-100 px-2 py-1 rounded uppercase">
                                            {{t.transaction_type }}</span></td>
                                    <td
                                        class="px-6 py-4 text-right font-bold {% if t.amount > 0 %}text-green-600{% else %}text-slate-800{% endif %}">
                                        {{ t.amount|intcomma }}</td>
                                    <td class="px-6 py-4 text-center font-mono text-xs text-slate-500">
                                        {{t.balance_after|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="ledger-pagination"
                        class="p-3 border-t border-slate-200 flex justify-between items-center bg-slate-50">
                        <span class="text-xs text-slate-500">Page <span id="ledger-current">{{
                                transactions.number}}</span> of <span
                                id="ledger-total">{{transactions.paginator.num_pages}}</span></span>
                        <div class="flex gap-2">
                            <button {% if not transactions.has_previous %}disabled{% endif %} id="ledger-prev"
                                onclick="changeLedgerPage(-1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Prev</button>
                            <button {% if not transactions.has_next %}disabled{% endif %} id="ledger-next"
                                onclick="changeLedgerPage(1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="tab === 'topups'" style="display: none;" class="p-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 items-end">
                    <div class="relative lg:col-span-1">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Reference</label>
                        <i class="ph-bold ph-magnifying-glass absolute left-3 bottom-2.5 text-slate-400"></i>
                        <input type="text" id="topup-search" oninput="triggerTopupSearch()" placeholder="Search Ref..."
                            class="w-full pl-9 pr-4 py-2 text-sm border border-slate-300 rounded-lg outline-none">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Status</label>
                        <select id="topup-status" onchange="triggerTopupSearch()"
                            class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white outline-none">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="approved">Refused</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Amount (DZD)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="topup-min-amt" oninput="triggerTopupSearch()" placeholder="Min"
                                class="w-full border border-slate-300 rounded-lg px-2 py-2 text-xs">
                            <input type="number" id="topup-max-amt" oninput="triggerTopupSearch()" placeholder="Max"
                                class="w-full border border-slate-300 rounded-lg px-2 py-2 text-xs">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Date Range</label>
                        <div class="flex items-center gap-2">
                            <input type="date" id="topup-date-from" onchange="triggerTopupSearch()"
                                class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                            <input type="date" id="topup-date-to" onchange="triggerTopupSearch()"
                                class="w-full border border-slate-300 rounded-lg px-2 py-1 text-xs">
                        </div>
                    </div>
                </div>

                <div class="border border-slate-200 rounded-xl">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[700px]">
                            <thead
                                class="bg-slate-50 text-xs uppercase text-slate-500 font-bold border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Ref Number</th>
                                    <th class="px-6 py-4 text-right">Amount</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                    <th class="px-6 py-4 text-right">Receipt</th>
                                </tr>
                            </thead>
                            <tbody id="topup-body" class="divide-y divide-slate-100 text-sm"></tbody>
                        </table>
                    </div>
                    <div id="topup-pagination"
                        class="p-3 border-t border-slate-200 flex justify-between items-center bg-slate-50">
                        <span class="text-xs text-slate-500">Page <span id="topup-current">1</span> of <span
                                id="topup-total">1</span></span>
                        <div class="flex gap-2">
                            <button id="topup-prev" onclick="changeTopupPage(-1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Prev</button>
                            <button id="topup-next" onclick="changeTopupPage(1)"
                                class="px-3 py-1 text-xs font-bold bg-white border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="topup-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeTopUpModal()"></div>
    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in transform transition-all scale-100">

        <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
            <div>
                <h3 class="text-xl font-bold text-slate-900">Request Top-Up</h3>
                <p class="text-xs text-slate-500">Add funds to your agency wallet</p>
            </div>
            <button onclick="closeTopUpModal()"
                class="w-8 h-8 rounded-full bg-slate-50 hover:bg-slate-100 text-slate-500 flex items-center justify-center transition-colors">
                <i class="ph-bold ph-x"></i>
            </button>
        </div>

        <form id="topupForm" class="space-y-5">
            {% csrf_token %}
            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1.5">Amount to Add</label>
                <div class="relative group">
                    <span
                        class="absolute left-3 top-3 text-slate-400 font-bold group-focus-within:text-brand-600">DZD</span>
                    <input type="number" name="amount" required step="0.01"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 focus:ring-2 focus:ring-brand-500 focus:bg-white outline-none font-bold text-slate-900 text-lg transition-all"
                        placeholder="0.00">
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1.5">Payment Reference</label>
                <input type="text" name="reference" placeholder="e.g. CCP Trans 990212"
                    class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-brand-500 focus:bg-white transition-all">
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1.5">Upload Receipt</label>
                <div class="relative group">
                    <input type="file" name="receipt_image" required id="fileInput"
                        class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                        onchange="updateFileName(this)">
                    <div
                        class="border-2 border-dashed border-slate-300 group-hover:border-brand-400 group-hover:bg-brand-50/50 rounded-xl p-6 text-center transition-all">
                        <div
                            class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-3 text-brand-600">
                            <i class="ph-duotone ph-upload-simple text-2xl"></i>
                        </div>
                        <p id="fileNameDisplay" class="text-sm font-medium text-slate-600">Click to upload photo or PDF
                        </p>
                        <p class="text-[10px] text-slate-400 mt-1">Max file size 5MB</p>
                    </div>
                </div>
            </div>

            <div class="pt-2">
                <button type="button" onclick="submitTopUpAJAX()"
                    class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand-600/20 hover:shadow-brand-600/30 transition-all transform hover:-translate-y-0.5">
                    Submit Request
                </button>
            </div>
        </form>
    </div>
</div>

<!-- modal -->
<div id="invoice-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeInvoiceModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden fade-in transform transition-all scale-100 flex flex-col max-h-[90vh]">

        <div class="bg-slate-50 border-b border-slate-100 p-6 flex justify-between items-start">
            <div>
                <p class="text-xs font-bold text-slate-500 uppercase mb-1">Invoice Details</p>
                <h3 class="text-2xl font-bold text-slate-900 flex items-center gap-3">
                    <span id="modal-inv-number">Loading...</span>
                    <span id="modal-inv-status"
                        class="text-xs px-2 py-1 rounded-full bg-slate-200 text-slate-600 uppercase tracking-wide">...</span>
                </h3>
            </div>
            <button onclick="closeInvoiceModal()"
                class="w-8 h-8 rounded-full bg-white border border-slate-200 hover:bg-slate-50 text-slate-400 hover:text-slate-600 flex items-center justify-center transition-colors">
                <i class="ph-bold ph-x"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto">
            <div class="flex gap-8 mb-8 text-sm">
                <div>
                    <span class="block text-slate-400 text-xs font-medium">Issue Date</span>
                    <span class="font-bold text-slate-700" id="modal-inv-date">-</span>
                </div>
                <div>
                    <span class="block text-slate-400 text-xs font-medium">Due Date</span>
                    <span class="font-bold text-slate-700" id="modal-inv-due">-</span>
                </div>
            </div>

            <table class="w-full text-left text-sm border-collapse mb-6">
                <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold">
                    <tr>
                        <th class="px-4 py-3 rounded-l-lg">Description</th>
                        <th class="px-4 py-3 text-right rounded-r-lg">Amount</th>
                    </tr>
                </thead>
                <tbody id="modal-items-list" class="divide-y divide-slate-100">
                </tbody>
                <tfoot class="border-t-2 border-slate-100">
                    <tr>
                        <td class="px-4 py-4 text-right font-bold text-slate-500 uppercase text-xs">Total</td>
                        <td class="px-4 py-4 text-right text-xl font-bold text-slate-900" id="modal-inv-total">0.00 DZD
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">

            <div id="modal-payment-section">
            </div>

            <div class="flex gap-3">
                <button onclick="printInvoiceFromModal()"
                    class="px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-900 flex items-center gap-2">
                    <i class="ph-bold ph-printer"></i> Print
                </button>
                <a id="modal-download-btn" href="#" target="_blank"
                    class="px-4 py-2 text-sm font-bold text-brand-600 hover:text-brand-700 bg-brand-50 hover:bg-brand-100 rounded-lg flex items-center gap-2 transition-colors">
                    <i class="ph-bold ph-download-simple"></i> Download PDF
                </a>
            </div>
        </div>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>



<script>
    // ========================================================
    // 1. TOP-UP MODAL & AJAX SUBMISSION
    // ========================================================
    function openTopUpModal() { document.getElementById('topup-modal').classList.remove('hidden'); }
    function closeTopUpModal() { document.getElementById('topup-modal').classList.add('hidden'); }

    function updateFileName(input) {
        if (input.files && input.files[0]) {
            const name = input.files[0].name;
            document.getElementById('fileNameDisplay').innerText = name.length > 25 ? name.substring(0, 25) + '...' : name;
            document.getElementById('fileNameDisplay').classList.add('text-brand-600', 'font-bold');
        }
    }

    function submitTopUpAJAX() {
        const form = document.getElementById('topupForm');
        const btn = form.querySelector('button');
        const originalText = btn.innerText;

        if (!form.checkValidity()) { form.reportValidity(); return; }

        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Sending...';

        const formData = new FormData(form);
        fetch("{% url 'finance:submit_topup_ajax' %}", {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success') {
                    btn.innerHTML = '<i class="ph-bold ph-check"></i> Sent!';
                    btn.classList.replace('bg-brand-600', 'bg-green-600');
                    setTimeout(() => { closeTopUpModal(); window.location.reload(); }, 1000);
                } else {
                    alert("Error: " + d.msg);
                    btn.disabled = false; btn.innerText = originalText;
                }
            })
            .catch(e => {
                console.error(e);
                alert("Server Error");
                btn.disabled = false;
                btn.innerText = originalText;
            });
    }

    // ========================================================
    // 2. STATE & TRIGGER ENGINE
    // ========================================================
    // --- STATE ---
    let invPage = 1;
    let ledgerPage = 1;
    let invTimeout, ledgerTimeout;

    // --- INVOICE METHODS ---
    function triggerInvoiceSearch() {
        clearTimeout(invTimeout);
        invPage = 1;
        invTimeout = setTimeout(fetchInvoices, 400);
    }

    function changeInvoicePage(delta) {
        invPage += delta;
        fetchInvoices();
    }

    function fetchInvoices() {
        const params = new URLSearchParams({
            action: 'get_invoices',
            page: invPage,
            q: document.getElementById('inv-search').value,
            status: document.getElementById('inv-status').value,
            date_from: document.getElementById('inv-date-from').value,
            date_to: document.getElementById('inv-date-to').value
        });

        fetch(`{% url 'finance:api_router' %}?${params}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                renderInvoices(data.items);
                updatePagination('inv', data);
            });
    }

    // --- LEDGER METHODS ---
    function triggerLedgerSearch() {
        clearTimeout(ledgerTimeout);
        ledgerPage = 1;
        ledgerTimeout = setTimeout(fetchLedger, 400);
    }

    function changeLedgerPage(delta) {
        ledgerPage += delta;
        fetchLedger();
    }

    function fetchLedger() {
        const params = new URLSearchParams({
            action: 'get_ledger',
            page: ledgerPage,
            q: document.getElementById('ledger-search').value,
            date_from: document.getElementById('ledger-date-from').value,
            date_to: document.getElementById('ledger-date-to').value
        });

        fetch(`{% url 'finance:api_router' %}?${params}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                renderLedger(data.items);
                updatePagination('ledger', data);
            });
    }

    // --- UTILITIES ---
    function updatePagination(prefix, data) {
        // prefix is 'inv' or 'ledger'
        document.getElementById(`${prefix}-current`).innerText = data.current_page;
        document.getElementById(`${prefix}-total`).innerText = data.total_pages;

        const prevBtn = document.getElementById(`${prefix}-prev`);
        const nextBtn = document.getElementById(`${prefix}-next`);

        prevBtn.disabled = !data.has_prev;
        nextBtn.disabled = !data.has_next;
    }

    // Re-use your existing table rendering logic here, just ensure they target 'inv-body' and 'ledger-body'
    // ========================================================
    // 3. TABLE REBUILDERS (Maintaining your Design)
    // ========================================================
    function renderInvoices(items) {
        // Corrected ID to match your HTML: 'inv-body'
        const tbody = document.getElementById('inv-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-16 text-center text-slate-400">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3 text-2xl text-slate-300"><i class="ph-duotone ph-receipt"></i></div>
                <p class="font-medium">No invoices found</p>
            </div></td></tr>`;
            return;
        }

        items.forEach(item => {
            let statusHTML = '';

            if (item.status === 'unpaid') {
                statusHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-100 uppercase tracking-wide">
                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Unpaid
                      </span>`;
            } else if (item.status === 'paid') {
                statusHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-green-50 text-green-700 border border-green-100 uppercase tracking-wide">
                        <i class="ph-bold ph-check text-green-600"></i> Paid
                      </span>`;
            } else if (item.status === 'refunded') {
                statusHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-blue-50 text-blue-700 border border-blue-100 uppercase tracking-wide">
                        <i class="ph-bold ph-arrow-counter-clockwise text-blue-600"></i> Refunded
                      </span>`;
            } else if (item.status === 'cancelled') {
                statusHTML = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200 uppercase tracking-wide">
                        <i class="ph-bold ph-x-circle text-slate-500"></i> Cancelled
                      </span>`;
            } else {
                statusHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold bg-slate-50 text-slate-500 border border-slate-200 uppercase tracking-wide">
                        ${item.status_display}
                      </span>`;
            }

            tbody.innerHTML += `
        <tr onclick="openInvoiceModal(${item.id})" class="group hover:bg-slate-50 transition-colors cursor-pointer">
            <td class="px-6 py-4"><span class="font-mono font-bold text-slate-900 bg-slate-100 px-2 py-1 rounded text-xs">#${item.number}</span></td>
            <td class="px-6 py-4 text-slate-500 text-xs font-medium">${item.date}</td>
            <td class="px-6 py-4 font-bold text-slate-900 tabular-nums">${item.amount} <span class="text-[10px] text-slate-400 font-normal">DZD</span></td>
            <td class="px-6 py-4 text-center">${statusHTML}</td>
            <td class="px-6 py-4 text-right"><button onclick="event.stopPropagation()" class="text-slate-400 hover:text-brand-600 transition-colors p-2 hover:bg-brand-50 rounded-lg"><i class="ph-bold ph-download-simple text-lg"></i></button></td>
        </tr>`;
        });
    }

    function renderLedger(items) {
        // Corrected ID to match your HTML: 'ledger-body'
        const tbody = document.getElementById('ledger-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-16 text-center text-slate-400">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3 text-2xl text-slate-300"><i class="ph-duotone ph-list-dashes"></i></div>
                <p class="font-medium">No transactions found</p>
            </div></td></tr>`;
            return;
        }

        items.forEach(item => {
            let typeBadge = '';
            if (item.type === 'deposit') typeBadge = '<span class="text-[10px] font-bold text-green-700 bg-green-50 border border-green-100 px-2 py-1 rounded uppercase">Top Up</span>';
            else if (item.type === 'refund') typeBadge = '<span class="text-[10px] font-bold text-blue-700 bg-blue-50 border border-blue-100 px-2 py-1 rounded uppercase">Refund</span>';
            else typeBadge = '<span class="text-[10px] font-bold text-slate-500 bg-slate-100 border border-slate-200 px-2 py-1 rounded uppercase">Payment</span>';

            const amountClass = item.amount_is_positive ? 'text-green-600' : 'text-slate-800';
            const sign = item.amount_is_positive ? '+' : '';

            tbody.innerHTML += `
        <tr class="group hover:bg-slate-50 transition-colors">
            <td class="px-6 py-4 text-slate-500 whitespace-nowrap"><span class="font-medium text-slate-700 block">${item.date}</span><span class="text-[10px] text-slate-400">${item.time}</span></td>
            <td class="px-6 py-4"><div class="font-bold text-slate-800">${item.description}</div><div class="text-xs text-slate-400 font-mono mt-0.5">${item.ref}</div></td>
            <td class="px-6 py-4">${typeBadge}</td>
            <td class="px-6 py-4 text-right font-bold tabular-nums ${amountClass}">${sign}${item.amount}</td>
            <td class="px-6 py-4 text-center font-mono text-xs text-slate-500 tabular-nums">${item.balance_after}</td>
        </tr>`;
        });
    }
    // ========================================================
    // 4. PAGINATION UI
    // ========================================================
    function updatePaginationUI(prefix, pageData) {
        const currentEl = document.getElementById(`${prefix}-current-page`);
        const totalEl = document.getElementById(`${prefix}-total-pages`);
        if (!currentEl || !totalEl) return;

        currentEl.innerText = pageData.current;
        totalEl.innerText = pageData.total_pages;

        const prevBtn = document.getElementById(`${prefix}-prev-btn`);
        const nextBtn = document.getElementById(`${prefix}-next-btn`);

        prevBtn.disabled = !pageData.has_prev;
        nextBtn.disabled = !pageData.has_next;

        prevBtn.style.opacity = pageData.has_prev ? '1' : '0.5';
        nextBtn.style.opacity = pageData.has_next ? '1' : '0.5';
    }

    // ========================================================
    // 5. EVENT LISTENERS
    // ========================================================
    document.addEventListener('DOMContentLoaded', () => {
        const inputIds = ['searchInput', 'filterStatus', 'filterDateFrom', 'filterDateTo', 'filterMin', 'filterMax'];
        inputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', triggerSearch);
                el.addEventListener('change', triggerSearch);
            }
        });
    });
    // ========================================================
    // 4. INVOICE MODAL & PAYMENTS
    // ========================================================
    function openInvoiceModal(id) {
        const modal = document.getElementById('invoice-modal');
        modal.classList.remove('hidden');

        // Reset UI
        document.getElementById('modal-inv-number').innerText = 'Loading...';
        document.getElementById('modal-items-list').innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">Fetching details...</td></tr>';

        // Set Download Link
        document.getElementById('modal-download-btn').href = `/accounting/invoice/${id}/pdf/`;

        // Fetch Details
        fetch(`/accounting/api/invoice/${id}/details/`)
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const inv = data.invoice;

                    // Fill Header
                    document.getElementById('modal-inv-number').innerText = '#' + inv.number;
                    document.getElementById('modal-inv-date').innerText = inv.date;
                    document.getElementById('modal-inv-due').innerText = inv.due_date;
                    document.getElementById('modal-inv-total').innerText = inv.total + ' DZD';

                    // Payment Button Logic
                    const paySection = document.getElementById('modal-payment-section');
                    if (inv.status === 'unpaid') {
                        paySection.innerHTML = `
                            <button onclick="payInvoiceAJAX(${id})" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-md shadow-green-600/20 transition-all flex items-center gap-2">
                                <i class="ph-bold ph-wallet"></i> Pay Now (${inv.total})
                            </button>
                        `;
                    } else if (inv.status === 'paid') {
                        paySection.innerHTML = `
                            <div class="flex items-center gap-2 text-green-700 font-bold text-sm bg-green-50 px-3 py-1.5 rounded-lg border border-green-100">
                                <i class="ph-fill ph-check-circle"></i> Paid on ${inv.date}
                            </div>
                        `;
                    } else {
                        paySection.innerHTML = '';
                    }

                    // Status Badge Logic
                    const statusEl = document.getElementById('modal-inv-status');
                    statusEl.innerText = inv.status;
                    if (inv.status === 'paid') statusEl.className = "text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 font-bold uppercase tracking-wide";
                    else if (inv.status === 'unpaid') statusEl.className = "text-xs px-2 py-1 rounded-full bg-red-100 text-red-700 font-bold uppercase tracking-wide";
                    else statusEl.className = "text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-600 font-bold uppercase tracking-wide";

                    // Build Items List
                    const tbody = document.getElementById('modal-items-list');
                    tbody.innerHTML = '';
                    data.items.forEach(item => {
                        tbody.innerHTML += `
                            <tr>
                                <td class="px-4 py-3 text-slate-700 font-medium">
                                    ${item.description}
                                    <span class="block text-[10px] text-slate-400 font-normal">Service ID: ${item.service}</span>
                                </td>
                                <td class="px-4 py-3 text-right font-bold text-slate-900">${item.amount}</td>
                            </tr>`;
                    });
                }
            })
            .catch(err => {
                console.error(err);
                alert("Failed to load invoice details.");
                closeInvoiceModal();
            });
    }

    function closeInvoiceModal() {
        document.getElementById('invoice-modal').classList.add('hidden');
    }

    function printInvoiceFromModal() {
        const url = document.getElementById('modal-download-btn').href;
        if (url && url !== '#') {
            window.open(url, '_blank').print();
        } else {
            alert("Invoice loading... please wait.");
        }
    }

    function payInvoiceAJAX(id) {
        if (!confirm("Are you sure you want to pay this invoice with your wallet balance?")) return;

        const btn = document.querySelector('#modal-payment-section button');
        const originalContent = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Processing...';

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/accounting/api/invoice/${id}/pay/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    btn.className = "bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 cursor-default";
                    btn.innerHTML = '<i class="ph-bold ph-check"></i> Paid Successfully!';

                    // Refresh Data without reload (optional: window.location.reload() is simpler)
                    setTimeout(() => {
                        closeInvoiceModal();
                        triggerSearch(); // Refresh list to show 'paid' status
                    }, 1000);
                } else {
                    alert("Payment Failed: " + data.msg);
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Server connection error.");
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    }

    // ========================================================
    // 5. TOP UP CODE
    // ========================================================

    let topupPage = 1;
    let topupTimeout;

    function triggerTopupSearch() {
        clearTimeout(topupTimeout);
        topupPage = 1;
        topupTimeout = setTimeout(fetchTopups, 400);
    }

    function changeTopupPage(delta) {
        topupPage += delta;
        fetchTopups();
    }

    function fetchTopups() {
        const apiUrl = document.getElementById('apiUrl').value;
        const params = new URLSearchParams({
            action: 'get_topups',
            page: topupPage,
            q: document.getElementById('topup-search').value,
            status: document.getElementById('topup-status').value, // NEW
            min_amt: document.getElementById('topup-min-amt').value, // NEW
            max_amt: document.getElementById('topup-max-amt').value, // NEW
            date_from: document.getElementById('topup-date-from').value,
            date_to: document.getElementById('topup-date-to').value
        });

        fetch(`${apiUrl}?${params}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                renderTopups(data.items);
                updatePagination('topup', data);
            });
    }

    function renderTopups(items) {
        const tbody = document.getElementById('topup-body');
        tbody.innerHTML = '';

        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400 italic">No top-up requests found</td></tr>';
            return;
        }

        items.forEach(item => {
            // Map status to Tailwind colors
            let statusBadge = '';
            if (item.status === 'pending') {
                statusBadge = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-amber-50 text-amber-700 border border-amber-100 uppercase tracking-wide">
                            <span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span> Pending</span>`;
            } else if (item.status === 'approved') {
                statusBadge = `<span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-green-50 text-green-700 border border-green-100 uppercase tracking-wide">
                            <i class="ph-bold ph-check"></i> Approved</span>`;
            } else {
                statusBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-100 uppercase tracking-wide">Rejected</span>`;
            }

            tbody.innerHTML += `
            <tr class="group hover:bg-slate-50 transition-colors">
                <td class="px-6 py-4 text-slate-500 whitespace-nowrap">
                    <span class="font-medium text-slate-700 block">${item.date}</span>
                    <span class="text-[10px] text-slate-400">${item.time}</span>
                </td>
                <td class="px-6 py-4">
                    <div class="font-bold text-slate-800">Reference / CCP</div>
                    <div class="text-xs text-slate-400 font-mono mt-0.5">${item.ref}</div>
                </td>
                <td class="px-6 py-4 text-right font-bold text-slate-900">${item.amount} <span class="text-xs text-slate-400 font-normal">DZD</span></td>
                <td class="px-6 py-4 text-center">${statusBadge}</td>
                <td class="px-6 py-4 text-right">
                    ${item.receipt_url ? `<a href="${item.receipt_url}" target="_blank" class="text-slate-400 hover:text-brand-600 p-2 inline-block"><i class="ph-bold ph-file-image text-lg"></i></a>` : ''}
                </td>
            </tr>`;
        });
    }

</script>


{% endblock %}