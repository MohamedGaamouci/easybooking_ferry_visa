{% extends 'admin/base_admin.html' %}

{% block content %}

<main class="flex-1 flex flex-col h-screen overflow-hidden relative">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <h1 class="text-xl font-bold text-slate-900">Product Management (CMS)</h1>
        <div class="flex items-center gap-3">
            <button class="text-slate-500 hover:text-brand-600 font-medium text-sm flex items-center gap-1">
                <i class="ph-bold ph-eye"></i> View Client Site
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto space-y-12">

            <section class="space-y-6">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-slate-900">Ferry Management</h2>

                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <button onclick="switchFerryTab('providers')" id="tab-btn-providers"
                                class="px-4 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-slate-800 transition-all">
                                Providers
                            </button>
                            <button onclick="switchFerryTab('ports')" id="tab-btn-ports"
                                class="px-4 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all">
                                Ports
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3">
                        <button id="tab-btn-pricing" onclick="openOpsModal()" class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-emerald-100 hover:border-emerald-300
           focus:ring-2 focus:ring-emerald-400/40 flex items-center gap-2 transition-all">
                            Schedules & Pricing
                        </button>
                        <button id="btn-add-ferry" onclick="openProviderModal('new')"
                            class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-slate-50 flex items-center gap-2 transition-colors">
                            <i class="ph-bold ph-plus"></i> Add Provider
                        </button>
                    </div>
                </div>

                <div id="tab-content-providers"
                    class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden animate-fade-in">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Logo</th>
                                <th class="px-6 py-4">Provider Name</th>
                                <th class="px-6 py-4">Code</th>
                                <th class="px-6 py-4">Contact</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
                            {% for provider in ferry_providers %}
                            <tr class="hover:bg-slate-50 group transition-colors">
                                <td class="px-6 py-4">
                                    <div
                                        class="w-10 h-10 bg-slate-100 rounded flex items-center justify-center overflow-hidden border border-slate-200">
                                        {% if provider.logo %}
                                        <img src="{{ provider.logo.url }}" class="w-full h-full object-cover">
                                        {% else %}
                                        <i class="ph-fill ph-boat text-xl text-slate-300"></i>
                                        {% endif %}
                                    </div>
                                </td>

                                <td class="px-6 py-4 font-bold text-slate-800">{{ provider.name }}</td>

                                <td
                                    class="px-6 py-4 text-xs font-mono text-slate-500 bg-slate-100 px-2 py-1 rounded w-fit">
                                    {{ provider.code }}</td>

                                <td class="px-6 py-4 text-xs text-slate-500">
                                    {% if provider.contact_email %}
                                    <div class="flex items-center gap-1"><i class="ph-bold ph-envelope"></i>
                                        {{provider.contact_email }}</div>
                                    {% endif %}

                                    {% if provider.contact_phone %}
                                    <div class="flex items-center gap-1 mt-1"><i class="ph-bold ph-phone"></i>
                                        {{provider.contact_phone }}</div>
                                    {% endif %}
                                </td>

                                <td class="px-6 py-4">
                                    {% if provider.is_active %}
                                    <span
                                        class="inline-flex items-center gap-1.5 text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded-full border border-green-100">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Active
                                    </span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center gap-1.5 text-slate-500 font-bold text-xs bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                                        <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> Disabled
                                    </span>
                                    {% endif %}
                                </td>

                                <td class="px-6 py-4 text-right">
                                    <div
                                        class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openProviderModal('edit', '{{ provider.id }}')"
                                            class="w-8 h-8 rounded hover:bg-purple-50 hover:text-purple-600 flex items-center justify-center text-slate-400 transition-colors">
                                            <i class="ph-bold ph-pencil-simple"></i>
                                        </button>
                                        <!-- <button onclick="deleteFerryItem('provider', '{{ provider.id }}')"
                                            class="w-8 h-8 rounded hover:bg-red-50 hover:text-red-500 flex items-center justify-center text-slate-400 transition-colors">
                                            <i class="ph-bold ph-trash"></i>
                                        </button> -->
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-slate-400 italic">No providers added
                                    yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="tab-content-ports"
                    class="hidden bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden animate-fade-in">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Port Name</th>
                                <th class="px-6 py-4">Code</th>
                                <th class="px-6 py-4">City</th>
                                <th class="px-6 py-4">Country</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
                            {% for port in ports %}
                            <tr class="hover:bg-slate-50 group transition-colors">
                                <td class="px-6 py-4 font-bold text-slate-800 flex items-center gap-2">
                                    <i class="ph-fill ph-anchor text-slate-300"></i> {{ port.name }}
                                </td>
                                <td
                                    class="px-6 py-4 text-xs font-mono text-slate-500 bg-slate-100 px-2 py-1 rounded w-fit">
                                    {{ port.code }}</td>
                                <td class="px-6 py-4 text-slate-600">{{ port.city }}</td>
                                <td class="px-6 py-4 text-slate-600">{{ port.country }}</td>
                                <td class="px-6 py-4">
                                    {% if port.is_active %}
                                    <span
                                        class="inline-flex items-center gap-1.5 text-green-600 font-bold text-xs bg-green-50 px-2 py-1 rounded-full border border-green-100">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Active
                                    </span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center gap-1.5 text-slate-500 font-bold text-xs bg-slate-100 px-2 py-1 rounded-full border border-slate-200">
                                        <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span> Disabled
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div
                                        class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openPortModal('edit', '{{ port.id }}')"
                                            class="w-8 h-8 rounded hover:bg-purple-50 hover:text-purple-600 flex items-center justify-center text-slate-400 transition-colors"><i
                                                class="ph-bold ph-pencil-simple"></i></button>
                                        <button onclick="deleteFerryItem('port', '{{ port.id }}')"
                                            class="w-8 h-8 rounded hover:bg-red-50 hover:text-red-500 flex items-center justify-center text-slate-400 transition-colors"><i
                                                class="ph-bold ph-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-slate-400 italic">No ports added yet.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <section>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-bold text-slate-900">Visa Destinations</h2>
                        <span
                            class="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded font-medium">Catalog</span>
                    </div>

                    <div class="flex items-center gap-3">

                        <form method="GET" class="flex items-center gap-2">
                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                                <input type="text" name="q" value="{{ search_query }}"
                                    placeholder="Search country, type..."
                                    class="pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none w-48 shadow-sm">
                            </div>

                            <select name="status" id="status-filter-select" onchange="this.form.submit()"
                                class="py-2 pl-3 pr-8 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white shadow-sm cursor-pointer">
                                <option value="">All Status</option>
                                <option value="active">Active Only</option>
                                <option value="disabled">Disabled</option>
                            </select>

                            <button type="submit" class="hidden"></button>
                        </form>

                        <button onclick="openVisaModal('new')"
                            class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2 ml-2">
                            <i class="ph-bold ph-plus-circle"></i> Add New
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {% for dest in visa_destinations %}
                    <div
                        class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden group hover:shadow-md transition-shadow relative {% if not dest.is_active %}opacity-75 grayscale{% endif %}">

                        <div class="h-40 bg-slate-100 bg-cover bg-center relative"
                            style="background-image: url('{% if dest.cover_image %}{{ dest.cover_image.url }}{% else %}https://placehold.co/600x400?text=No+Image{% endif %}');">

                            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors"></div>

                            <div class="absolute top-2 left-2">
                                {% if dest.is_active %}
                                <span
                                    class="bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">Active</span>
                                {% else %}
                                <span
                                    class="bg-slate-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">Disabled</span>
                                {% endif %}
                            </div>

                            <div
                                class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openVisaModal('edit', '{{ dest.id }}')"
                                    class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center text-slate-700 hover:text-brand-600 shadow-sm transition-colors">
                                    <i class="ph-bold ph-pencil-simple"></i>
                                </button>
                                <button onclick="confirmDelete('{{ dest.id }}')"
                                    class="w-8 h-8 bg-white/90 rounded-full flex items-center justify-center text-red-500 hover:bg-red-50 shadow-sm transition-colors">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>

                            <div class="absolute bottom-3 left-4 text-white">
                                <h3 class="font-bold text-lg">{{ dest.country }}</h3>
                                <div class="flex flex-col">
                                    <span class="text-xs opacity-90 font-medium">{{ dest.visa_type }}</span>
                                    {% if dest.visa_name %}
                                    <span class="text-[10px] opacity-75">{{ dest.visa_name }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="p-4 flex justify-between items-center border-t border-slate-100">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Embassy Price
                                </p>
                                <p class="font-bold text-slate-900 text-sm">{{ dest.net_price }} DZ</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Selling Price
                                </p>
                                <p class="font-bold text-green-600 text-sm">{{ dest.selling_price }} DZ</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div
                        class="col-span-full py-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">
                        <i class="ph-duotone ph-airplane-tilt text-4xl mb-2"></i>
                        <p>No destinations found matching your criteria.</p>
                        {% if search_query or status_filter %}
                        <a href="?" class="text-brand-600 font-bold text-sm mt-2 hover:underline">Clear Filters</a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {% if visa_destinations.has_other_pages %}
                <div class="mt-8 flex items-center justify-between border-t border-slate-200 pt-4">
                    <div class="text-sm text-slate-500">
                        Showing page <span class="font-bold text-slate-900">{{ visa_destinations.number }}</span>
                        of {{ visa_destinations.paginator.num_pages }}
                    </div>

                    <div class="flex gap-2">
                        {% if visa_destinations.has_previous %}
                        <a href="?page={{ visa_destinations.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                            Previous
                        </a>
                        {% else %}
                        <span
                            class="px-3 py-1.5 border border-slate-100 rounded-lg text-sm font-bold text-slate-300 cursor-not-allowed">Previous</span>
                        {% endif %}

                        {% if visa_destinations.has_next %}
                        <a href="?page={{ visa_destinations.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                            Next
                        </a>
                        {% else %}
                        <span
                            class="px-3 py-1.5 border border-slate-100 rounded-lg text-sm font-bold text-slate-300 cursor-not-allowed">Next</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </section>

        </div>
    </div>

</main>

<div id="visa-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeVisaModal()"></div>
    <style>
        /* Toggle Checkbox Logic */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
            /* Green border */
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #68D391;
            /* Green background */
        }

        .toggle-checkbox {
            right: auto;
            left: 0;
            transition: all 0.3s ease-in-out;
        }

        .toggle-checkbox:checked {
            left: auto;
            right: 0;
        }
    </style>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden modal-enter">

        <div class="bg-purple-700 p-4 shrink-0 text-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="ph-bold ph-passport"></i> Create New Visa Destination
                </h3>
                <button onclick="closeVisaModal()" class="hover:bg-purple-600 p-1 rounded transition-colors">
                    <i class="ph-bold ph-x text-lg"></i>
                </button>
            </div>

            <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                <div class="flex-1">
                    <div class="flex justify-between mb-1 opacity-90">
                        <span>1. Basic Info</span>
                        <span id="step-indicator">Step 1 of 3</span>
                    </div>
                    <div class="w-full bg-purple-900/30 h-1.5 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-white h-full w-1/3 transition-all duration-300"></div>
                    </div>
                </div>
            </div>
        </div>

        <form id="visa-wizard-form" class="flex-1 overflow-hidden relative bg-slate-50">
            {% csrf_token %}

            <div id="step-1" class="absolute inset-0 p-8 overflow-y-auto space-y-6 transition-transform duration-300">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Country Name <span
                                class="text-red-500">*</span></label>
                        <input type="text" name="country" required placeholder="e.g. France"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Visa Name</label>
                        <input type="text" name="visa_name" placeholder="e.g. France Schengen 2025"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Visa Type <span
                                class="text-red-500">*</span></label>
                        <input type="text" name="visa_type" required placeholder="e.g. Tourist, Business"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Processing Time</label>
                        <input type="text" name="processing_time" placeholder="e.g. 10-15 Days"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Net Price (Embassy)</label>
                        <div class="relative">
                            <span class="absolute right-1 top-2.5 text-slate-400 font-bold">DZ</span>
                            <input type="number" step="0.01" name="net_price" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 pl-7 text-sm font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Selling Price</label>
                        <div class="relative">
                            <span class="absolute right-1 top-2.5 text-slate-400 font-bold">DZ</span>
                            <input type="number" step="0.01" name="selling_price" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 pl-7 text-sm font-bold text-green-600">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Visa Conditions /
                        Requirements</label>
                    <div class="relative">
                        <textarea name="conditions" rows="4" placeholder="• Valid Passport&#10;• 2 Photos"
                            onfocus="if(this.value==='') this.value='• ';"
                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.value = this.value + '\n• '; }"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-purple-500 outline-none bg-slate-50 leading-relaxed"></textarea>
                        <p class="text-[10px] text-slate-400 mt-1 italic text-right">Press Enter to add a new point.</p>
                    </div>
                </div>

                <div
                    class="flex items-center justify-between bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase">Client Visibility</label>
                        <p class="text-[10px] text-slate-500">If unchecked, this destination is hidden from clients.</p>
                    </div>
                    <label class="flex items-center cursor-pointer">
                        <div class="relative inline-block w-12 h-6 align-middle select-none">
                            <input type="checkbox" name="is_active" checked
                                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300" />
                            <label
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer"></label>
                        </div>
                        <span class="ml-2 text-xs font-bold text-slate-700 uppercase"
                            id="active-status-text">Active</span>
                    </label>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cover Image</label>
                    <input type="file" name="cover_image" accept="image/*"
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                </div>
            </div>

            <div id="step-2"
                class="absolute inset-0 p-8 overflow-y-auto space-y-6 translate-x-full transition-transform duration-300 hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-slate-800">Required Documents</h4>
                        <p class="text-xs text-slate-500">What files must the client upload?</p>
                    </div>
                    <button type="button" onclick="addDocRow()"
                        class="text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 px-3 py-2 rounded-lg transition-colors border border-purple-200">
                        <i class="ph-bold ph-plus"></i> Add Document
                    </button>
                </div>

                <div id="docs-container" class="space-y-3">
                    <div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"
                        id="docs-empty-state">
                        No documents required yet. Click "Add Document" to start.
                    </div>
                </div>
            </div>

            <div id="step-3"
                class="absolute inset-0 p-8 overflow-y-auto space-y-6 translate-x-full transition-transform duration-300 hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-slate-800">Application Form Questions</h4>
                        <p class="text-xs text-slate-500">Build the questions the client must answer.</p>
                    </div>
                    <button type="button" onclick="addQuestionRow()"
                        class="text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 px-3 py-2 rounded-lg transition-colors border border-purple-200">
                        <i class="ph-bold ph-plus"></i> Add Question
                    </button>
                </div>

                <div id="questions-container" class="space-y-3">
                    <div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl"
                        id="questions-empty-state">
                        No custom questions added.
                    </div>
                </div>
            </div>
        </form>

        <div class="p-4 border-t border-slate-200 bg-white flex justify-between items-center shrink-0 z-10">
            <button type="button" id="btn-back" onclick="changeStep(-1)" disabled
                class="px-5 py-2.5 rounded-lg text-sm font-bold text-slate-400 border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                Back
            </button>
            <button type="button" id="btn-next" onclick="changeStep(1)"
                class="px-8 py-2.5 rounded-lg text-sm font-bold text-white bg-purple-600 hover:bg-purple-700 shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2">
                Next Step <i class="ph-bold ph-arrow-right"></i>
            </button>
            <button type="button" id="btn-submit" onclick="submitVisaWizard()"
                class="hidden px-8 py-2.5 rounded-lg text-sm font-bold text-white bg-green-600 hover:bg-green-700 shadow-md hover:-translate-y-0.5 transition-all flex items-center gap-2">
                <i class="ph-bold ph-check"></i> Create Destination
            </button>
        </div>
    </div>
</div>

<select id="master-port-select" class="hidden">
    <option value="">Select Port...</option>
    {% for port in ports %}
    {% if port.is_active %}
    <option value="{{ port.id }}">{{ port.name }} ({{ port.code }})</option>
    {% endif %}
    {% endfor %}
</select>

<div id="provider-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeProviderModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col overflow-hidden modal-enter">

        <div class="bg-blue-600 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold flex items-center gap-2"><i class="ph-bold ph-boat"></i> <span
                    id="prov-modal-title">Manage Provider</span></h3>
            <button onclick="closeProviderModal()"><i class="ph-bold ph-x"></i></button>
        </div>

        <form id="provider-form" onsubmit="event.preventDefault(); saveProvider();"
            class="flex-1 overflow-y-auto p-6 space-y-6">

            <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-6">
                <div class="col-span-2">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Basic Information</h4>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Provider Name <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="name" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Code <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="code" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono uppercase">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" name="contact_email"
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Phone</label>
                    <input type="text" name="contact_phone"
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Logo</label>
                    <input type="file" name="logo" accept="image/*"
                        class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="col-span-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="is_active" checked
                            class="rounded text-blue-600 focus:ring-blue-500">
                        <span class="text-sm font-medium text-slate-700">Provider Active Status</span>
                    </label>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Operating Routes</h4>
                    <button type="button" onclick="addRouteRow()"
                        class="text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded-lg border border-blue-200 transition-colors">
                        <i class="ph-bold ph-plus"></i> Add Route
                    </button>
                </div>

                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-semibold">
                            <tr>
                                <th class="px-3 py-2">Origin Port</th>
                                <th class="px-3 py-2 text-center"><i class="ph-bold ph-arrows-left-right"></i></th>
                                <th class="px-3 py-2">Destination Port</th>
                                <th class="px-3 py-2">Notes</th>
                                <th class="px-3 py-2 w-16 text-center">Active</th>
                                <th class="px-3 py-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="routes-container" class="divide-y divide-slate-100 bg-white">
                        </tbody>
                    </table>

                    <div id="routes-empty-state" class="p-8 text-center text-slate-400 italic text-sm">
                        No routes added. Click "Add Route" to define connections.
                    </div>
                </div>
            </div>

            <div class="pt-4 border-t border-slate-100 flex justify-end gap-3">
                <button type="button" onclick="closeProviderModal()"
                    class="px-4 py-2 text-slate-500 font-bold text-sm hover:bg-slate-50 rounded-lg">Cancel</button>
                <button type="submit" id="btn-save-provider"
                    class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow hover:bg-blue-700 text-sm transition-all">Save
                    Provider</button>
            </div>
        </form>
    </div>
</div>

<div id="port-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closePortModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden modal-enter">
        <div class="bg-slate-700 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold flex items-center gap-2"><i class="ph-bold ph-anchor"></i> <span
                    id="port-modal-title">Add Port</span></h3>
            <button onclick="closePortModal()"><i class="ph-bold ph-x"></i></button>
        </div>
        <form id="port-form" onsubmit="event.preventDefault(); savePort();" class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Port Name <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="name" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Code <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="code" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono uppercase"
                        placeholder="e.g. ALG">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">City <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="city" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Country <span
                            class="text-red-500">*</span></label>
                    <input type="text" name="country" required
                        class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                </div>
            </div>

            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="is_active" checked class="rounded text-slate-600 focus:ring-slate-500">
                    <span class="text-sm font-medium text-slate-700">Active Status</span>
                </label>
                <button type="submit"
                    class="bg-slate-700 text-white font-bold py-2 px-6 rounded-lg shadow hover:bg-slate-800 text-sm">Save
                    Port</button>
            </div>
        </form>
    </div>
</div>

<div id="ops-modal-overlay"
    class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
            <div class="flex items-center gap-3">
                <div id="ops-back-btn"
                    class="hidden cursor-pointer h-8 w-8 flex items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 hover:bg-slate-100"
                    onclick="backToOpsGrid()">
                    <i class="ph-bold ph-arrow-left"></i>
                </div>

                <div>
                    <h3 id="ops-modal-title" class="text-lg font-bold text-slate-800">Schedules & Pricing</h3>
                    <p id="ops-modal-subtitle" class="text-xs text-slate-500 font-medium">Select a provider to manage
                        operations</p>
                </div>
            </div>
            <button onclick="closeOpsModal()"
                class="h-9 w-9 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400 transition-all">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <div id="ops-modal-body" class="p-6 overflow-y-auto min-h-[400px]">
        </div>

        <div class="px-6 py-4 border-t border-slate-100 bg-white flex justify-end">
            <button onclick="closeOpsModal()"
                class="px-6 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors">Close</button>
        </div>
    </div>
</div>



<script>
    // --- VISA MODAL ---
    const visaModal = document.getElementById('visa-modal');
    function openVisaModal(mode) { visaModal.classList.remove('hidden'); }
    function closeVisaModal() { visaModal.classList.add('hidden'); }
    function saveVisa() {
        const btn = document.querySelector('#visa-modal button[type="submit"]');
        btn.innerHTML = 'Saving...';
        setTimeout(() => { alert("Visa Destination Saved!"); closeVisaModal(); btn.innerHTML = 'Save Visa'; }, 800);
    }

    // --- FERRY MODAL ---
    const ferryModal = document.getElementById('ferry-modal');
    function openFerryModal(mode) { ferryModal.classList.remove('hidden'); }
    function closeFerryModal() { ferryModal.classList.add('hidden'); }
    function saveFerry() {
        const btn = document.querySelector('#ferry-modal button[type="submit"]');
        btn.innerHTML = 'Saving...';
        setTimeout(() => { alert("Provider Updated Successfully!"); closeFerryModal(); btn.innerHTML = 'Save Provider'; }, 800);
    }

    // --- GLOBAL DELETE ---
    function confirmDelete() {
        if (confirm("Are you sure you want to delete this item? This action cannot be undone.")) {
            alert("Item deleted.");
        }
    }
</script>



<!-- active filter -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. Get the 'status' parameter from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentStatus = urlParams.get('status');

        // 2. Find the dropdown
        const selectEl = document.getElementById('status-filter-select');

        // 3. Set the value if it exists
        if (currentStatus && selectEl) {
            selectEl.value = currentStatus;
        }
    });
</script>

<script>
    // --- 1. GLOBAL STATE ---
    let currentStep = 1;
    const totalSteps = 3;
    let editingDestId = null;

    // DOM Elements
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');
    const progressBar = document.getElementById('progress-bar');
    const stepIndicator = document.getElementById('step-indicator');
    const btnBack = document.getElementById('btn-back');
    const btnNext = document.getElementById('btn-next');
    const btnSubmit = document.getElementById('btn-submit');

    // --- 2. OPEN MODAL ---
    function openVisaModal(mode, id = null) {
        const modal = document.getElementById('visa-modal');
        const form = document.getElementById('visa-wizard-form');
        const title = modal.querySelector('h3');
        const submitBtn = document.getElementById('btn-submit'); // Fix selector

        // RESET STEPS
        currentStep = 1;
        updateWizardUI();

        // Show Step 1, Hide others
        resetStepClasses(step1, true);
        resetStepClasses(step2, false);
        resetStepClasses(step3, false);

        modal.classList.remove('hidden');

        if (mode === 'new') {
            // === CREATE MODE ===
            editingDestId = null;
            title.innerHTML = '<i class="ph-bold ph-passport"></i> Create New Visa Destination';
            submitBtn.innerHTML = '<i class="ph-bold ph-check"></i> Create Destination';

            form.reset();

            // Reset Dynamic Containers to default empty state
            document.getElementById('docs-container').innerHTML =
                '<div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl" id="docs-empty-state">No documents required yet. Click "Add Document" to start.</div>';

            document.getElementById('questions-container').innerHTML =
                '<div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl" id="questions-empty-state">No custom questions added.</div>';

        } else if (mode === 'edit' && id) {
            // === EDIT MODE ===
            editingDestId = id;
            title.innerHTML = '<i class="ph-bold ph-pencil"></i> Edit Visa Destination';
            submitBtn.innerHTML = '<i class="ph-bold ph-floppy-disk"></i> Save Changes';

            fetch(`/admin_panel/api/visa/destination/${id}/`)
                .then(res => {
                    if (!res.ok) throw new Error("API URL not found");
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        populateVisaModal(data);
                    } else {
                        closeVisaModal();
                        alert("Error loading data: " + data.message);
                    }
                })
                .catch(err => {
                    closeVisaModal();
                    console.error(err);
                    alert("System Error: " + err.message);
                });
        }
    }

    // --- 3. CLOSE MODAL ---
    function closeVisaModal() {
        document.getElementById('visa-modal').classList.add('hidden');
    }

    // --- 4. NAVIGATION ---
    function changeStep(direction) {
        // Validate Step 1
        if (currentStep === 1 && direction === 1) {
            const required = step1.querySelectorAll('[required]');
            let valid = true;
            required.forEach(input => {
                if (!input.value) { input.classList.add('border-red-500'); valid = false; }
                else { input.classList.remove('border-red-500'); }
            });
            if (!valid) return alert("Please fill in required fields.");
        }

        // Hide Current Step
        const currentEl = getStepEl(currentStep);
        currentEl.classList.add('hidden');
        currentEl.classList.add(direction === 1 ? '-translate-x-full' : 'translate-x-full');

        // Update Index
        currentStep += direction;

        // Show New Step
        const newEl = getStepEl(currentStep);
        newEl.classList.remove('hidden', 'translate-x-full', '-translate-x-full');

        updateWizardUI();
    }

    function resetStepClasses(el, isVisible) {
        if (isVisible) {
            el.classList.remove('hidden', 'translate-x-full', '-translate-x-full');
        } else {
            el.classList.add('hidden', 'translate-x-full');
        }
    }

    function getStepEl(step) {
        if (step === 1) return step1;
        if (step === 2) return step2;
        if (step === 3) return step3;
    }

    function updateWizardUI() {
        const percent = (currentStep / totalSteps) * 100;
        progressBar.style.width = `${percent}%`;
        stepIndicator.innerText = `Step ${currentStep} of ${totalSteps}`;

        btnBack.disabled = currentStep === 1;
        if (currentStep === totalSteps) {
            btnNext.classList.add('hidden');
            btnSubmit.classList.remove('hidden');
        } else {
            btnNext.classList.remove('hidden');
            btnSubmit.classList.add('hidden');
        }
    }

    // --- 5. SUBMIT LOGIC ---
    function submitVisaWizard() {
        const btn = document.getElementById('btn-submit');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
        btn.disabled = true;

        const form = document.getElementById('visa-wizard-form');

        const payload = {
            visa_destination: {
                country: form.querySelector('[name="country"]').value,
                visa_name: form.querySelector('[name="visa_name"]').value,
                visa_type: form.querySelector('[name="visa_type"]').value,
                net_price: form.querySelector('[name="net_price"]').value,
                selling_price: form.querySelector('[name="selling_price"]').value,
                processing_time: form.querySelector('[name="processing_time"]').value,
                is_active: form.querySelector('[name="is_active"]').checked,
                conditions: form.querySelector('[name="conditions"]').value
            },
            required_docs: [],
            visa_form_fields: []
        };

        // Collect Docs
        document.querySelectorAll('.doc-row').forEach(row => {
            const name = row.querySelector('.doc-name').value;
            if (name) {
                payload.required_docs.push({
                    name: name,
                    description: row.querySelector('.doc-desc').value,
                    is_required: row.querySelector('.doc-req').checked
                });
            }
        });

        // Collect Questions
        document.querySelectorAll('.question-row').forEach((row, index) => {
            const label = row.querySelector('.q-label').value;
            if (label) {
                payload.visa_form_fields.push({
                    label: label,
                    field_type: row.querySelector('.q-type').value,
                    options: row.querySelector('.q-options').value,
                    is_required: row.querySelector('.q-req').checked,
                    order_index: index
                });
            }
        });

        const formData = new FormData();
        formData.append('json_data', JSON.stringify(payload));
        const fileInput = form.querySelector('[name="cover_image"]');
        if (fileInput.files.length > 0) {
            formData.append('cover_image', fileInput.files[0]);
        }

        let url = "{% url 'visa_destination_create' %}";
        if (editingDestId) {
            url = `/admin_panel/api/visa/update_destination/${editingDestId}/`;
        }

        fetch(url, {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeVisaModal();
                    alert(editingDestId ? "✅ Updated Successfully!" : "✅ Created Successfully!");
                    window.location.reload();
                } else {
                    closeVisaModal();
                    alert("⚠️ Error: " + data.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                closeVisaModal();
                console.error(err);
                alert("❌ System Error");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    // --- 6. HELPERS (Populate & Add Rows) ---

    // NOTE: This function was fixing the crash logic
    function populateVisaModal(data) {
        const d = data.destination;
        const form = document.getElementById('visa-wizard-form');

        // 1. Fill Info
        form.querySelector('[name="country"]').value = d.country;
        form.querySelector('[name="visa_name"]').value = d.visa_name || '';
        form.querySelector('[name="visa_type"]').value = d.visa_type;
        form.querySelector('[name="net_price"]').value = d.net_price;
        form.querySelector('[name="selling_price"]').value = d.selling_price;
        form.querySelector('[name="processing_time"]').value = d.processing_time;
        form.querySelector('[name="is_active"]').checked = d.is_active;
        form.querySelector('[name="conditions"]').value = d.conditions || '';

        // 2. Fill Documents
        const docContainer = document.getElementById('docs-container');
        docContainer.innerHTML = ''; // Wipe everything

        if (data.documents && data.documents.length > 0) {
            data.documents.forEach(doc => { addDocRowWithData(doc); });
        } else {
            // Restore Empty State if no docs
            docContainer.innerHTML = '<div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl" id="docs-empty-state">No documents required yet.</div>';
        }

        // 3. Fill Questions
        const qContainer = document.getElementById('questions-container');
        qContainer.innerHTML = ''; // Wipe everything

        if (data.questions && data.questions.length > 0) {
            data.questions.forEach(q => { addQuestionRowWithData(q); });
        } else {
            // Restore Empty State if no questions
            qContainer.innerHTML = '<div class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl" id="questions-empty-state">No custom questions added.</div>';
        }
    }

    function addDocRow() { addDocRowWithData({}); }
    function addQuestionRow() { addQuestionRowWithData({}); }

    function addDocRowWithData(data = {}) {
        // SAFE CHECK: Only hide if element exists
        const emptyState = document.getElementById('docs-empty-state');
        if (emptyState) { emptyState.classList.add('hidden'); }

        const id = Date.now() + Math.random();
        const html = `
        <div class="doc-row grid grid-cols-12 gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm animate-fade-in items-start" id="doc-${id}">
            <div class="col-span-4"><input type="text" value="${data.name || ''}" placeholder="Name" class="doc-name w-full text-sm border-slate-200 rounded p-2 bg-slate-50" required></div>
            <div class="col-span-6"><input type="text" value="${data.description || ''}" placeholder="Desc" class="doc-desc w-full text-sm border-slate-200 rounded p-2 bg-slate-50"></div>
            <div class="col-span-2 flex items-center justify-end gap-2 pt-2">
                <label class="flex items-center gap-1"><input type="checkbox" ${data.is_required !== false ? 'checked' : ''} class="doc-req w-4 h-4 text-purple-600 rounded"><span class="text-[10px] font-bold text-slate-500">Req.</span></label>
                <button type="button" onclick="document.getElementById('doc-${id}').remove()" class="text-red-400 hover:text-red-600"><i class="ph-bold ph-trash"></i></button>
            </div>
        </div>`;
        document.getElementById('docs-container').insertAdjacentHTML('beforeend', html);
    }

    function addQuestionRowWithData(data = {}) {
        // SAFE CHECK: Only hide if element exists
        const emptyState = document.getElementById('questions-empty-state');
        if (emptyState) { emptyState.classList.add('hidden'); }

        const id = Date.now() + Math.random();
        const html = `
        <div class="question-row bg-white p-4 rounded-lg border border-slate-200 shadow-sm animate-fade-in space-y-3" id="q-${id}">
            <div class="flex justify-between items-start">
                <div class="flex-1 grid grid-cols-2 gap-4">
                    <input type="text" value="${data.label || ''}" placeholder="Label" class="q-label w-full text-sm border-slate-200 rounded p-2 border font-bold">
                    <select onchange="toggleOptions(this)" class="q-type w-full text-sm border-slate-200 rounded p-2 border bg-slate-50">
                        <option value="text" ${data.field_type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="date" ${data.field_type === 'date' ? 'selected' : ''}>Date</option>
                        <option value="select" ${data.field_type === 'select' ? 'selected' : ''}>Dropdown</option>
                        <option value="checkbox" ${data.field_type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                        <option value="number" ${data.field_type === 'number' ? 'selected' : ''}>Number</option>
                    </select>
                </div>
                <button type="button" onclick="document.getElementById('q-${id}').remove()" class="ml-4 text-red-400 hover:text-red-600 p-1"><i class="ph-bold ph-trash"></i></button>
            </div>
            <div class="options-container ${data.field_type === 'select' ? '' : 'hidden'}">
                <input type="text" value="${data.options || ''}" placeholder="Options..." class="q-options w-full text-xs border-slate-200 rounded p-2 bg-yellow-50 border border-yellow-200">
            </div>
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 bg-slate-50 px-2 py-1 rounded border border-slate-200"><input type="checkbox" ${data.is_required !== false ? 'checked' : ''} class="q-req w-3 h-3 text-purple-600 rounded"><span class="text-xs font-bold text-slate-500">Required</span></label>
            </div>
        </div>`;
        document.getElementById('questions-container').insertAdjacentHTML('beforeend', html);
    }

    function toggleOptions(selectEl) {
        const row = selectEl.closest('.question-row');
        if (selectEl.value === 'select') row.querySelector('.options-container').classList.remove('hidden');
        else row.querySelector('.options-container').classList.add('hidden');
    }
</script>


<!-- ferries -->
<script>
    // --- TAB LOGIC ---
    function switchFerryTab(tab) {
        // 1. Update Buttons
        const btnProv = document.getElementById('tab-btn-providers');
        const btnPort = document.getElementById('tab-btn-ports');
        const btnAdd = document.getElementById('btn-add-ferry');

        // Reset Styles
        btnProv.className = "px-4 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all";
        btnPort.className = "px-4 py-1.5 text-xs font-bold rounded-md text-slate-500 hover:text-slate-700 transition-all";

        // Active Style
        const activeClass = "px-4 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-slate-800 transition-all";

        // 2. Toggle Content & Button Text
        if (tab === 'providers') {
            document.getElementById('tab-content-providers').classList.remove('hidden');
            document.getElementById('tab-content-ports').classList.add('hidden');
            btnProv.className = activeClass;
            btnAdd.innerHTML = '<i class="ph-bold ph-plus"></i> Add Provider';
            btnAdd.setAttribute('onclick', "openProviderModal('new')");
        } else {
            document.getElementById('tab-content-providers').classList.add('hidden');
            document.getElementById('tab-content-ports').classList.remove('hidden');
            btnPort.className = activeClass;
            btnAdd.innerHTML = '<i class="ph-bold ph-plus"></i> Add Port';
            btnAdd.setAttribute('onclick', "openPortModal('new')");
        }
    }

    // --- MODAL LOGIC (PROVIDERS) ---
    function openProviderModal(mode, id = null) {
        const modal = document.getElementById('provider-modal');
        const form = document.getElementById('provider-form');
        document.getElementById('prov-modal-title').innerText = mode === 'new' ? 'Add Provider' : 'Edit Provider';

        // Clear form if new, Fetch if edit (Implement Fetch logic similar to Visa)
        if (mode === 'new') form.reset();

        modal.classList.remove('hidden');
    }
    function closeProviderModal() {
        document.getElementById('provider-modal').classList.add('hidden');
    }

    // --- MODAL LOGIC (PORTS) ---
    function openPortModal(mode, id = null) {
        const modal = document.getElementById('port-modal');
        const form = document.getElementById('port-form');
        document.getElementById('port-modal-title').innerText = mode === 'new' ? 'Add Port' : 'Edit Port';

        if (mode === 'new') form.reset();

        modal.classList.remove('hidden');
    }
    function closePortModal() {
        document.getElementById('port-modal').classList.add('hidden');
    }
</script>
<!-- crud operations -->
<script>
    // --- PORT SAVE LOGIC ---
    function savePort() {
        const form = document.getElementById('port-form');
        const formData = new FormData(form);
        const btn = form.querySelector('button[type="submit"]');
        const originalText = btn.innerText;

        // Loading State
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
        btn.disabled = true;

        // Determine URL (Create vs Update)
        // We need a variable 'editingPortId' similar to what we did for Visa
        // (Ensure you declare 'let editingPortId = null;' at the top of your script)

        let url = "{% url 'port_create' %}";
        if (editingPortId) {
            url = `/admin_panel/api/ferry/port/update/${editingPortId}/`;
        }

        fetch(url, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closePortModal();
                    alert("✅ " + data.message);
                    window.location.reload();
                } else {
                    alert("⚠️ Error: " + data.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ System Error");
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }
    let editingPortId = null; // Global Variable

    function openPortModal(mode, id = null) {
        const modal = document.getElementById('port-modal');
        const form = document.getElementById('port-form');
        document.getElementById('port-modal-title').innerText = mode === 'new' ? 'Add Port' : 'Edit Port';

        modal.classList.remove('hidden');

        if (mode === 'new') {
            editingPortId = null;
            form.reset();
        } else {
            editingPortId = id;
            // Fetch Data for Edit
            fetch(`/admin_panel/api/ferry/port/${id}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const p = data.port;
                        form.querySelector('[name="name"]').value = p.name;
                        form.querySelector('[name="code"]').value = p.code;
                        form.querySelector('[name="city"]').value = p.city;
                        form.querySelector('[name="country"]').value = p.country;
                        form.querySelector('[name="is_active"]').checked = p.is_active;
                    }
                });
        }
    }

</script>
<script>
    // --- GLOBAL VARS ---
    let editingProviderId = null;

    // --- 1. MODAL OPEN/CLOSE ---
    function openProviderModal(mode, id = null) {
        const modal = document.getElementById('provider-modal');
        const form = document.getElementById('provider-form');
        const title = document.getElementById('prov-modal-title');

        // Reset UI
        document.getElementById('routes-container').innerHTML = '';
        document.getElementById('routes-empty-state').classList.remove('hidden');

        modal.classList.remove('hidden');

        if (mode === 'new') {
            editingProviderId = null;
            title.innerText = 'Add New Provider';
            form.reset();
        } else {
            editingProviderId = id;
            title.innerText = 'Edit Provider';

            // Fetch Data
            fetch(`/admin_panel/api/ferry/provider/${id}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const p = data.provider;
                        // Fill Basic Info
                        form.querySelector('[name="name"]').value = p.name;
                        form.querySelector('[name="code"]').value = p.code;
                        form.querySelector('[name="contact_email"]').value = p.contact_email;
                        form.querySelector('[name="contact_phone"]').value = p.contact_phone;
                        form.querySelector('[name="is_active"]').checked = p.is_active;

                        // Fill Routes
                        if (data.routes && data.routes.length > 0) {
                            data.routes.forEach(route => addRouteRow(route));
                        }
                    }
                })
                .catch(err => alert("Error loading provider data."));
        }
    }

    function closeProviderModal() {
        document.getElementById('provider-modal').classList.add('hidden');
    }

    // --- 2. DYNAMIC ROUTE ROWS ---
    function addRouteRow(data = {}) {
        const container = document.getElementById('routes-container');
        document.getElementById('routes-empty-state').classList.add('hidden');

        const rowId = Date.now() + Math.random();

        // Get Port Options from Master Select
        const portOptions = document.getElementById('master-port-select').innerHTML;

        const html = `
        <tr id="route-${rowId}" class="route-row group hover:bg-slate-50 transition-colors" data-route-id="${data.id || ''}">
            <td class="px-3 py-2">
                <select class="route-origin w-full border border-slate-300 rounded p-1.5 text-xs bg-white outline-none focus:border-blue-500">
                    ${portOptions}
                </select>
            </td>
            <td class="px-3 py-2 text-center text-slate-300">
                <i class="ph-bold ph-arrow-right"></i>
            </td>
            <td class="px-3 py-2">
                <select class="route-dest w-full border border-slate-300 rounded p-1.5 text-xs bg-white outline-none focus:border-blue-500">
                    ${portOptions}
                </select>
            </td>
            <td class="px-3 py-2">
                <input type="text" class="route-notes w-full border border-slate-300 rounded p-1.5 text-xs outline-none focus:border-blue-500" 
                       placeholder="Optional notes" value="${data.notes || ''}">
            </td>
            <td class="px-3 py-2 text-center">
                <input type="checkbox" class="route-active w-4 h-4 rounded text-blue-600" ${data.is_active !== false ? 'checked' : ''}>
            </td>

    <!-- <td class="px-3 py-2 text-center">
        <button type="button" onclick="document.getElementById('route-${rowId}').remove()"
            class="text-slate-300 hover:text-red-500 transition-colors">
            <i class="ph-bold ph-trash"></i>
        </button>
    </td> -->
        </tr>
        `;

        container.insertAdjacentHTML('beforeend', html);

        // Set Selected Values (must be done after HTML injection)
        const newRow = document.getElementById(`route-${rowId}`);
        if (data.origin_id) newRow.querySelector('.route-origin').value = data.origin_id;
        if (data.destination_id) newRow.querySelector('.route-dest').value = data.destination_id;
    }

    // --- 3. SAVE LOGIC ---
    function saveProvider() {
        const form = document.getElementById('provider-form');
        const btn = document.getElementById('btn-save-provider');
        const originalText = btn.innerText;

        btn.innerText = 'Saving...';
        btn.disabled = true;

        // 1. Gather Routes
        const routes = [];
        document.querySelectorAll('.route-row').forEach(row => {
            const origin = row.querySelector('.route-origin').value;
            const dest = row.querySelector('.route-dest').value;

            if (origin && dest) {
                routes.push({
                    id: row.dataset.routeId || null,
                    origin_id: origin,
                    destination_id: dest,
                    notes: row.querySelector('.route-notes').value,
                    is_active: row.querySelector('.route-active').checked
                });
            }
        });

        // 2. Prepare Form Data
        const formData = new FormData(form);
        formData.append('routes_json', JSON.stringify(routes));

        // 3. Send Request
        let url = "{% url 'provider_create' %}";
        if (editingProviderId) {
            url = `/admin_panel/api/ferry/provider/update/${editingProviderId}/`;
        }

        fetch(url, {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeProviderModal();
                    alert("✅ Saved Successfully!");
                    window.location.reload();
                } else {
                    alert("⚠️ Error: " + data.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("System Error");
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }
</script>
<!-- dates and pricing controle -->
<script>

    let globalFerryData = [];

    function openOpsModal() {
        const modal = document.getElementById('ops-modal-overlay');
        modal.classList.remove('hidden');
        loadOpsProviders();
    }

    function closeOpsModal() {
        document.getElementById('ops-modal-overlay').classList.add('hidden');
        backToOpsGrid(); // Reset state for next time
    }

    // 1. Load Providers into Grid
    async function loadOpsProviders() {
        const body = document.getElementById('ops-modal-body');
        const backBtn = document.getElementById('ops-back-btn');

        backBtn.classList.add('hidden');
        document.getElementById('ops-modal-title').innerText = "Schedules & Pricing";
        document.getElementById('ops-modal-subtitle').innerText = "Select a provider to manage operations";
        body.innerHTML = '<div class="flex items-center justify-center h-64"><i class="fas fa-spinner fa-spin fa-2x text-slate-300"></i></div>';

        try {
            const response = await fetch("{% url 'api_pricing_structure' %}"); // Ensure this URL is correct
            const result = await response.json();

            if (result.status === 'success') {
                globalFerryData = result.data;
                body.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${globalFerryData.map(p => `
                        <div onclick="showOpsRoutes(${p.id})" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl hover:border-emerald-500 hover:bg-emerald-50 cursor-pointer transition-all group text-center">
                            <div class="h-16 w-16 bg-white rounded-xl shadow-sm mx-auto mb-4 flex items-center justify-center p-2 group-hover:scale-110 transition-transform">
                                <img src="${p.logo || '/static/img/default-provider.png'}" class="max-h-full max-w-full object-contain">
                            </div>
                            <span class="font-bold text-slate-700 text-sm">${p.name}</span>
                            <div class="mt-2 text-[10px] text-slate-400 font-bold uppercase tracking-wider">${p.routes.length} Routes</div>
                        </div>
                    `).join('')}
                </div>`;
            }
        } catch (e) {
            body.innerHTML = `<div class="p-8 text-center text-red-500">Error: ${e.message}</div>`;
        }
    }

    // 2. Show Routes for Selected Provider
    function showOpsRoutes(providerId) {
        const provider = globalFerryData.find(p => p.id === providerId);
        const body = document.getElementById('ops-modal-body');
        const backBtn = document.getElementById('ops-back-btn');

        backBtn.classList.remove('hidden');
        document.getElementById('ops-modal-title').innerText = provider.name;
        document.getElementById('ops-modal-subtitle').innerText = "Select a route to manage its calendar or pricing";

        body.innerHTML = `
        <div class="overflow-hidden border border-slate-200 rounded-xl">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold">
                    <tr>
                        <th class="px-6 py-4">Sailing Route</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                    ${provider.routes.map(r => `
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="px-6 py-4 font-bold text-slate-700">
                                <span class="text-emerald-600">${r.origin}</span>
                                <i class="fas fa-long-arrow-alt-right mx-3 text-slate-300"></i>
                                <span class="text-blue-600">${r.destination}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${r.is_active ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${r.is_active ? 'ACTIVE' : 'INACTIVE'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right space-x-2">
                                <button onclick="openScheduleEditor(${r.id})" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-600 hover:text-white transition-all">
                                    <i class="fas fa-calendar-alt mr-1"></i> Calendar
                                </button>
                                <button onclick="openPriceEditor(${r.id})" class="bg-amber-50 text-amber-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-amber-600 hover:text-white transition-all">
                                    <i class="fas fa-tag mr-1"></i> Prices
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;
    }

    function backToOpsGrid() {
        loadOpsProviders();
    }

    // ----------------------
    // --- SCHEDULE EDITOR (Inside the same Modal) ---
    let selectedDates = []; // Temporary storage for bulk selection

    let currentViewOffset = 0; // 0 = Current 3 months, 1 = Next 3 months, etc.

    async function openScheduleEditor(routeId) {
        const body = document.getElementById('ops-modal-body');
        selectedDates = [];
        currentViewOffset = 0; // Reset to "Now" when opening

        document.getElementById('ops-modal-subtitle').innerText = "Select sailings. Use arrows to view future months.";
        body.innerHTML = '<div class="flex justify-center py-12"><i class="fas fa-spinner fa-spin fa-2x text-slate-200"></i></div>';

        try {
            const response = await fetch(`/admin_panel/api/admin/route/${routeId}/calendar/`);
            const result = await response.json();

            if (result.status === 'success') {
                const existingDates = result.data.map(d => d.date);
                // We store the existing dates in the global selectedDates so they remain selected
                selectedDates = [...existingDates];
                renderBulkCalendarUI(routeId);
            }
        } catch (e) {
            body.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
        }
    }

    function renderBulkCalendarUI(routeId) {
        const body = document.getElementById('ops-modal-body');
        const now = new Date();
        const startMonth = now.getMonth() + (currentViewOffset * 3);
        const startYear = now.getFullYear();

        body.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center justify-between bg-emerald-50 border border-emerald-100 p-4 rounded-xl">
                <div class="flex items-center gap-4">
                    <button
                        onclick="changeMonthOffset(${routeId}, -1)"
                        class="h-8 w-8 flex items-center justify-center rounded-full bg-white
                            border border-emerald-200 text-emerald-600
                            hover:bg-emerald-600 hover:text-white transition-all">
                        <i class="ph-bold ph-caret-left"></i>
                    </button>

                    <span class="text-sm font-bold text-emerald-800">
                        Viewing Next 3 Months
                    </span>

                    <button
                        onclick="changeMonthOffset(${routeId}, 1)"
                        class="h-8 w-8 flex items-center justify-center rounded-full bg-white
                            border border-emerald-200 text-emerald-600
                            hover:bg-emerald-600 hover:text-white transition-all">
                        <i class="ph-bold ph-caret-right"></i>
                    </button>
                </div>

                <button onclick="submitBulkSchedule(${routeId})" class="bg-emerald-600 text-white px-8 py-2.5 rounded-lg font-bold text-xs shadow-lg hover:bg-emerald-700 transition-all">
                    Save All Changes
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${generateMonthGrid(startYear, startMonth)}
                ${generateMonthGrid(startYear, startMonth + 1)}
                ${generateMonthGrid(startYear, startMonth + 2)}
            </div>
        </div>
    `;
    }

    function changeMonthOffset(routeId, delta) {
        currentViewOffset += delta;
        if (currentViewOffset < 0) currentViewOffset = 0; // Don't go to the past
        renderBulkCalendarUI(routeId);
    }

    function generateMonthGrid(year, month) {
        const d = new Date(year, month, 1);
        const monthName = d.toLocaleString('default', { month: 'long' });
        const adjYear = d.getFullYear();
        const adjMonth = d.getMonth();

        const daysInMonth = new Date(adjYear, adjMonth + 1, 0).getDate();
        const startDay = new Date(adjYear, adjMonth, 1).getDay();

        let html = `
        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
            <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 text-center font-black text-slate-700 text-xs uppercase tracking-widest">
                ${monthName} ${adjYear}
            </div>
            <div class="grid grid-cols-7 text-center text-[9px] font-bold text-slate-400 bg-slate-50/50">
                <div class="py-2">S</div><div class="py-2">M</div><div class="py-2">T</div><div class="py-2">W</div><div class="py-2">T</div><div class="py-2">F</div><div class="py-2">S</div>
            </div>
            <div class="grid grid-cols-7 p-2 gap-1.5">`;

        for (let i = 0; i < startDay; i++) html += `<div class="h-9"></div>`;

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${adjYear}-${String(adjMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isSelected = selectedDates.includes(dateStr);

            const style = isSelected
                ? 'bg-emerald-500 text-white border-emerald-600 shadow-sm'
                : 'bg-white text-slate-600 border-slate-100 hover:border-emerald-300 hover:bg-emerald-50';

            html += `
            <div id="cal-${dateStr}" 
                 onclick="toggleDateSelection('${dateStr}')" 
                 class="h-9 flex items-center justify-center rounded-lg border text-[11px] font-bold cursor-pointer transition-all ${style}">
                ${day}
            </div>`;
        }

        html += `</div></div>`;
        return html;
    }

    function toggleDateSelection(dateStr) {
        const el = document.getElementById(`cal-${dateStr}`);
        const index = selectedDates.indexOf(dateStr);

        if (index > -1) {
            // REMOVE from array (Deselect)
            selectedDates.splice(index, 1);
            // Visual: Turn back to White/Grey
            el.className = "h-9 flex items-center justify-center rounded-lg border text-[11px] font-bold cursor-pointer transition-all bg-white text-slate-600 border-slate-100 hover:border-emerald-300 hover:bg-emerald-50";
        } else {
            // ADD to array (Select)
            selectedDates.push(dateStr);
            // Visual: Turn Emerald/Green
            el.className = "h-9 flex items-center justify-center rounded-lg border text-[11px] font-bold cursor-pointer transition-all bg-emerald-500 text-white border-emerald-600 shadow-sm";
        }
    }

    async function submitBulkSchedule(routeId) {
        const btn = event.target;
        const originalText = btn.innerText;

        if (!confirm(`This will set exactly ${selectedDates.length} sailings for this route. Continue?`)) return;

        btn.innerText = "Syncing...";
        btn.disabled = true;

        try {
            const response = await fetch(`/admin_panel/api/admin/route/${routeId}/schedule/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ dates: selectedDates })
            });

            const result = await response.json();
            if (result.status === 'success') {
                alert("✅ Schedule Synchronized!");
                closeOpsModal();
            } else {
                alert("❌ Error: " + result.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert("System Error: " + e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // --- PRICE EDITOR (Inside the same Modal) ---
    async function openPriceEditor(routeId) {
        const body = document.getElementById('ops-modal-body');
        document.getElementById('ops-modal-subtitle').innerText = "Set component prices for specific seasons";
        body.innerHTML = '<div class="flex justify-center py-12"><i class="fas fa-spinner fa-spin fa-2x text-slate-200"></i></div>';

        try {
            const response = await fetch(`/admin_panel/api/admin/route/${routeId}/pricing/`);
            const result = await response.json();

            if (result.status === 'success') {
                body.innerHTML = `
                <div class="space-y-6">
                    <button onclick="renderPriceForm(${routeId})" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-800 transition-all">
                        + New Price Rule
                    </button>
                    
                    <div class="overflow-hidden border border-slate-200 rounded-xl">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px]">
                                <tr>
                                    <th class="px-4 py-3">Category</th>
                                    <th class="px-4 py-3">Item</th>
                                    <th class="px-4 py-3">Validity Period</th>
                                    <th class="px-4 py-3 text-right">Price</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${result.data.map(p => `
                                    <tr class="hover:bg-slate-50/50">
                                        <td class="px-4 py-3 font-bold text-blue-600 uppercase">${p.category}</td>
                                        <td class="px-4 py-3 text-slate-700 font-medium">${p.item_name}</td>
                                        <td class="px-4 py-3 text-slate-500 font-mono">${p.start_date} <i class="fas fa-arrow-right mx-1 text-[8px]"></i> ${p.end_date}</td>
                                        <td class="px-4 py-3 text-right font-black text-slate-900">${p.selling_price} DA</td>
                                        <td class="px-4 py-3 text-right">
                                            <button onclick="removePrice(${routeId}, ${p.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }
        } catch (e) {
            body.innerHTML = `<div class="text-red-500">Error: ${e.message}</div>`;
        }
    }


    async function saveNewDate(routeId) {
        const date = document.getElementById('new-sched-date').value;
        if (!date) return alert("Select a date first.");

        const response = await fetch(`/admin_panel/api/admin/route/${routeId}/schedule/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ dates: [date] })
        });

        if ((await response.json()).status === 'success') openScheduleEditor(routeId);
    }

    async function removeDate(routeId, scheduleId) {
        if (!confirm("Delete this sailing date?")) return;
        const response = await fetch(`/admin_panel/api/admin/schedule/delete/${scheduleId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
        if ((await response.json()).status === 'success') openScheduleEditor(routeId);
    }

    // --- Security Helper for Django CSRF ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}