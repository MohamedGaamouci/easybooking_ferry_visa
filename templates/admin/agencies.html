{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}

<main class="flex-1 flex flex-col h-screen overflow-hidden relative">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <h1 class="text-xl font-bold text-slate-900">Agency CRM</h1>
        <button onclick="openNewAgencyModal()"
            class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-slate-800 transition-colors flex items-center gap-2">
            <i class="ph-bold ph-plus"></i> Register Agency
        </button>
    </header>

    <div class="px-8 pt-6 pb-2 bg-white border-b border-slate-200 flex flex-wrap gap-4 items-center justify-between">
        <form method="GET" class="flex-1 flex gap-3 w-full">

            <div class="relative flex-1 max-w-md">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                <input type="text" name="q" value="{{ search_query }}"
                    placeholder="Search Agency, RC, Phone or Manager..."
                    class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none focus:border-brand-500 w-full shadow-sm">
            </div>

            <select name="status" id="filter-status" onchange="this.form.submit()"
                class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white text-slate-600 shadow-sm cursor-pointer">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="suspended">Suspended</option>
                <option value="rejected">Rejected</option>
            </select>

            <select name="balance" id="filter-balance" onchange="this.form.submit()"
                class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white text-slate-600 shadow-sm cursor-pointer">
                <option value="">All Finance</option>
                <option value="overdraft">Overdraft (Negative)</option>
                <option value="positive">Positive Balance</option>
            </select>

            <input type="text" name="tag" value="{{ current_tag }}" placeholder="Tags (e.g. VIP)"
                class="w-32 px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none focus:border-brand-500 shadow-sm">

            {% if search_query or current_status or current_balance or current_tag %}
            <a href="{% url 'agency_management' %}"
                class="px-3 py-2 text-sm text-red-500 hover:bg-red-50 rounded-lg font-bold transition-colors">Clear</a>
            {% endif %}
        </form>
    </div>

    <div class="flex-1 overflow-y-auto p-8 bg-slate-50/50">
        <div class="max-w-full space-y-8">

            {% if pending_count > 0 %}
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold text-slate-900 uppercase flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse"></span> Pending Applications
                    </h2>
                    <div class="flex items-center gap-3">
                        {% if pending_agencies.has_other_pages %}
                        <div class="flex items-center bg-white rounded-lg border border-slate-200 p-0.5 shadow-sm">
                            <button {% if pending_agencies.has_previous %}
                                onclick="updateQueryParam('pending_page', '{{ pending_agencies.previous_page_number }}')"
                                {% else %}disabled{% endif %}
                                class="p-1 rounded hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent transition-colors">
                                <i class="ph-bold ph-caret-left text-slate-500"></i>
                            </button>
                            <span class="text-[10px] font-bold text-slate-600 px-2 min-w-[30px] text-center">
                                {{ pending_agencies.number }} / {{ pending_agencies.paginator.num_pages }}
                            </span>
                            <button {% if pending_agencies.has_next%}
                                onclick="updateQueryParam('pending_page', '{{ pending_agencies.next_page_number }}')" {%
                                else %}disabled{% endif %}
                                class="p-1 rounded hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent transition-colors">
                                <i class="ph-bold ph-caret-right text-slate-500"></i>
                            </button>
                        </div>
                        {% endif %}
                        <span class="text-xs font-bold text-slate-400 border-l border-slate-200 pl-3">
                            {{ pending_count}} Requests</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5"> {% for agency in pending_agencies %}
                    <div
                        class="bg-white p-5 rounded-xl border border-yellow-200 shadow-sm hover:shadow-md transition-all relative overflow-hidden group flex flex-col h-full">
                        <div class="absolute top-0 left-0 w-1.5 h-full bg-yellow-400"></div>

                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-sm text-slate-900 leading-tight line-clamp-1"
                                    title="{{ agency.company_name }}">{{ agency.company_name }}</h3>
                                <p class="text-[10px] text-slate-500 mt-1">Submitted: {{ agency.created_at|timesince }}
                                    ago</p>
                            </div>
                            <div
                                class="w-7 h-7 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center border border-yellow-100 shrink-0">
                                <i class="ph-fill ph-clock text-xs"></i>
                            </div>
                        </div>

                        <div class="space-y-2 mb-4 flex-1">
                            <p class="text-xs text-slate-600 flex items-center gap-2">
                                <i class="ph-fill ph-user text-slate-400"></i>
                                {% if agency.manager %}
                                <span class="truncate">{{ agency.manager.first_name }}
                                    {{ agency.manager.last_name}}</span>
                                {% else %}
                                <span class="italic text-slate-400">No Manager</span>
                                {% endif %}
                            </p>
                            <p class="text-xs text-slate-600 flex items-center gap-2">
                                <i class="ph-fill ph-map-pin text-slate-400"></i> <span class="truncate">
                                    {{agency.city|default:"-" }}</span>
                            </p>
                        </div>

                        <div class="flex gap-2 border-t border-slate-100 pt-3 mt-auto">
                            <button data-id="{{ agency.id }}" data-name="{{ agency.company_name }}"
                                data-rc="{{ agency.rc_number }}" data-phone="{{ agency.phone }}"
                                data-address="{{ agency.address }}" data-city="{{ agency.city }}"
                                data-balance="{{ agency.balance }}" data-limit="{{ agency.credit_limit }}"
                                data-tags="{% for t in agency.tags.all %}{{ t.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                data-date="{{ agency.created_at|date:'M d, Y' }}"
                                data-logo="{% if agency.logo %}{{ agency.logo.url }}{% endif %}"
                                data-doc="{% if agency.rc_document %}{{ agency.rc_document.url }}{% endif %}"
                                data-manager-first="{{ agency.manager.first_name }}"
                                data-manager-last="{{ agency.manager.last_name }}"
                                data-manager-email="{{ agency.manager.email }}"
                                data-manager-phone="{{ agency.manager.phone }}"
                                data-manager-state="{{ agency.manager.state }}" onclick="openReviewModal(this)"
                                class="flex-1 bg-slate-900 text-white py-2 rounded-lg text-xs font-bold hover:bg-slate-800 transition-colors shadow-sm">
                                Review
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div>
                <h2 class="text-sm font-bold text-slate-900 uppercase mb-4">Active Agency Directory ({{ total_active }})
                </h2>
                <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead
                            class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Agency</th>
                                <th class="px-6 py-4">Manager</th>
                                <th class="px-6 py-4">Contact</th>
                                <th class="px-6 py-4">Balance</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 text-sm">
                            {% for agency in active_agencies %}
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-9 h-9 rounded-lg bg-slate-100 border border-slate-200 flex items-center justify-center overflow-hidden">
                                            {% if agency.logo %}
                                            <img src="{{ agency.logo.url }}" class="w-full h-full object-cover">
                                            {% else %}
                                            <span class="font-bold text-slate-500 text-[10px]">
                                                {{agency.company_name|slice:":2"|upper }}</span>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-900">{{ agency.company_name }}</div>
                                            <div class="text-xs text-slate-500 font-mono">{{ agency.rc_number }}</div>
                                        </div>
                                    </div>
                                </td>

                                <td class="px-6 py-4">
                                    {% if agency.manager %}
                                    <div class="font-medium text-slate-900">{{ agency.manager.first_name }}
                                        {{agency.manager.last_name }}</div>
                                    <div class="text-xs text-slate-500">{{ agency.manager.email }}</div>
                                    {% else %}
                                    <span class="text-xs text-red-400 italic">Unassigned</span>
                                    {% endif %}
                                </td>

                                <td class="px-6 py-4 text-slate-600">
                                    <div class="flex items-center gap-1.5"><i
                                            class="ph-bold ph-phone text-slate-400"></i> {{ agency.phone }}</div>
                                    <div class="flex items-center gap-1.5 mt-1 text-xs"><i
                                            class="ph-bold ph-map-pin text-slate-400"></i> {{ agency.city }}</div>
                                </td>

                                <td class="px-6 py-4">
                                    {% if agency.balance < 0 %} <span class="text-red-600 font-bold">DZD
                                        {{agency.balance }}</span>
                                        <div class="text-[10px] text-red-400">Overdraft</div>
                                        {% else %}
                                        <span class="text-green-600 font-bold">DZD {{ agency.balance }}</span>
                                        {% endif %}
                                </td>

                                <td class="px-6 py-4">
                                    {% if agency.status == 'active' %}
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold
                   bg-green-50 text-green-700 border border-green-100">
                                        Active
                                    </span>

                                    {% elif agency.status == 'suspended' %}
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold
                   bg-red-50 text-red-700 border border-red-100">
                                        Suspended
                                    </span>

                                    {% elif agency.status == 'rejected' %}
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold
                   bg-orange-50 text-orange-700 border border-orange-100">
                                        Rejected
                                    </span>

                                    {% else %}
                                    <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold
                   bg-slate-100 text-slate-500 border border-slate-200">
                                        {{ agency.status|capfirst }}
                                    </span>
                                    {% endif %}
                                </td>


                                <td class="px-6 py-4 text-right">
                                    <button onclick="openEditAgencyModal(this)" data-id="{{ agency.id }}"
                                        data-company-name="{{ agency.company_name }}" data-rc="{{ agency.rc_number }}"
                                        data-phone="{{ agency.phone }}" data-city="{{ agency.city }}"
                                        data-address="{{ agency.address }}" data-status="{{ agency.status }}"
                                        data-limit="{{ agency.credit_limit }}"
                                        data-tags="{% for t in agency.tags.all %}{{ t.name }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                        data-logo="{% if agency.logo %}{{ agency.logo.url }}{% endif %}"
                                        class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-all">
                                        <i class="ph-bold ph-pencil-simple"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-slate-400">No agencies match your
                                    search.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if active_agencies.has_other_pages %}
                <div class="mt-6 flex items-center justify-between border-t border-slate-200 pt-4">
                    <div class="text-sm text-slate-500">
                        Page <span class="font-bold text-slate-900">{{ active_agencies.number }}</span> of
                        {{active_agencies.paginator.num_pages }}
                    </div>
                    <div class="flex gap-2">
                        {% if active_agencies.has_previous %}
                        <a href="?page={{ active_agencies.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">Previous</a>
                        {% endif %}
                        {% if active_agencies.has_next %}
                        <a href="?page={{ active_agencies.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">Next</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
    </div>
</main>

<div id="new_agency_modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeNewAgencyModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden modal-enter">
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold text-lg flex items-center gap-2"><i class="ph-bold ph-buildings"></i> Register New
                Agency</h3>
            <button onclick="closeNewAgencyModal()"><i class="ph-bold ph-x text-lg"></i></button>
        </div>

        <form id="new_agency_form" onsubmit="event.preventDefault(); submitNewAgency();"
            class="flex-1 flex flex-col lg:flex-row overflow-hidden bg-slate-50">
            {% csrf_token %}

            <div class="flex-1 p-8 overflow-y-auto space-y-5">
                <div class="flex items-center gap-2 text-brand-700 font-bold border-b border-brand-200 pb-2">
                    <i class="ph-fill ph-briefcase"></i> Agency Details
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Company Name *</label>
                        <input type="text" name="company_name" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">RC Number *</label>
                        <input type="text" name="rc_number" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Agency Phone</label>
                        <input type="text" name="agency_phone"
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">City</label>
                        <select name="city" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white">
                            <option value="Algiers">Algiers</option>
                            <option value="Oran">Oran</option>
                            <option value="Setif">Setif</option>
                            <option value="Constantine">Constantine</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Address</label>
                        <input type="text" name="address"
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border border-slate-200 space-y-3 shadow-sm">
                    <label class="block text-xs font-bold text-slate-900 uppercase">Configuration</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Initial Status</label>
                            <select name="status"
                                class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-slate-50">
                                <option value="pending">Pending Review</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Credit Limit (DZD)</label>
                            <input type="number" name="credit_limit" value="0"
                                class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] text-slate-500 mb-1">Tags (Comma separated)</label>
                            <input type="text" name="tags" placeholder="e.g. VIP, Wholesaler"
                                class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] text-slate-400 uppercase font-bold">Logo</label><input type="file"
                            name="logo" class="w-full text-xs mt-1"></div>
                    <div><label class="text-[10px] text-slate-400 uppercase font-bold">RC Document</label><input
                            type="file" name="rc_document" class="w-full text-xs mt-1"></div>
                </div>
            </div>

            <div class="hidden lg:block w-px bg-slate-200 my-6"></div>

            <div class="flex-1 p-8 overflow-y-auto">
                <div class="flex items-center gap-2 text-brand-700 font-bold border-b border-brand-200 pb-2 mb-6">
                    <i class="ph-fill ph-user-gear"></i> Manager Information
                </div>

                <div class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">First Name
                                *</label><input type="text" name="first_name" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Last Name
                                *</label><input type="text" name="last_name" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mobile Phone
                                *</label><input type="tel" name="manager_phone" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">State *</label><input
                                name="state" type="text"
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white"></div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <label class="block text-xs font-bold text-blue-900 mb-2 uppercase">Access Control</label>
                        <label class="block text-[10px] text-slate-500 mb-1">Role</label>
                        <select name="role" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white">
                            <option value="">Select Role...</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email (Username) *</label>
                        <input type="email" name="email" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                    </div>

                    <div id="password-section">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                        <div class="relative">
                            <input type="text" id="input-password" name="password"
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono text-slate-700 bg-white">
                            <button type="button" onclick="generateUserPassword()"
                                class="absolute right-2 top-2 text-xs bg-slate-200 px-2 py-1 rounded hover:bg-slate-300 font-bold text-slate-600">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="p-4 border-t border-slate-200 bg-white flex justify-end gap-3 shrink-0">
            <button onclick="closeNewAgencyModal()"
                class="px-6 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">Cancel</button>
            <button onclick="document.getElementById('new_agency_form').dispatchEvent(new Event('submit'))"
                class="px-6 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow-md hover:bg-slate-800 flex items-center gap-2">
                <i class="ph-bold ph-check"></i> Create Agency & Manager
            </button>
        </div>
    </div>
</div>

<div id="edit_agency_modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeEditAgencyModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden modal-enter">
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
            <h3 class="font-bold text-lg flex items-center gap-2"><i class="ph-bold ph-pencil-simple"></i> Edit Agency
                Details</h3>
            <button onclick="closeEditAgencyModal()" class="hover:bg-slate-700 p-1 rounded transition-colors"><i
                    class="ph-bold ph-x text-lg"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-50 p-6">
            <form id="edit_agency_form" onsubmit="event.preventDefault(); updateAgency();"
                enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="edit-agency-id">

                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm mb-5">
                    <h4 class="text-xs font-bold text-slate-900 mb-4 uppercase flex items-center gap-2">
                        <i class="ph-fill ph-identification-card text-brand-500"></i> Identity & Branding
                    </h4>

                    <div class="flex flex-col md:flex-row gap-6">
                        <div
                            class="w-full md:w-1/4 flex flex-col items-center justify-center bg-slate-50 border border-dashed border-slate-300 rounded-lg p-4">
                            <div class="relative w-24 h-24 mb-3 group">
                                <img id="edit-logo-preview" src=""
                                    class="w-full h-full object-cover rounded-lg border border-slate-200 hidden shadow-sm">
                                <div id="edit-logo-placeholder"
                                    class="w-full h-full flex items-center justify-center bg-white rounded-lg border border-slate-100 text-slate-300">
                                    <i class="ph-fill ph-image text-3xl"></i>
                                </div>
                                <div
                                    class="absolute inset-0 bg-slate-900/50 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer pointer-events-none">
                                    <span class="text-xs text-white font-bold">Change</span>
                                </div>
                            </div>
                            <input type="file" name="logo" accept="image/*"
                                class="w-full text-[10px] text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded file:border-0 file:text-[10px] file:bg-white file:text-slate-700 hover:file:bg-slate-100">
                        </div>

                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Company
                                    Name</label>
                                <input type="text" id="edit-name" name="company_name" required
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-1 focus:ring-brand-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">RC
                                    Number</label>
                                <input type="text" id="edit-rc" name="rc_number" required
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Phone</label>
                                <input type="text" id="edit-phone" name="phone" required
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-900 mb-3 uppercase flex items-center gap-2">
                            <i class="ph-fill ph-map-pin text-brand-500"></i> Location
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">City</label>
                                <input type="text" id="edit-city" name="city"
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Full
                                    Address</label>
                                <textarea id="edit-address" name="address" rows="2"
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50/80 p-5 rounded-xl border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-900 mb-3 uppercase flex items-center gap-2">
                            <i class="ph-fill ph-sliders-horizontal"></i> Configuration
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Status</label>
                                <select id="edit-status" name="status"
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-1 focus:ring-blue-500">
                                    <option value="active">Active</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="pending">Pending</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Credit Limit (DZD)</label>
                                <input type="number" id="edit-limit" name="credit_limit"
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-[10px] text-slate-500 mb-1">Tags</label>
                                <input type="text" id="edit-tags" name="tags" placeholder="e.g. VIP, Wholesaler"
                                    class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="p-4 border-t border-slate-200 bg-white flex justify-end gap-3 shrink-0">
            <button onclick="closeEditAgencyModal()"
                class="px-5 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
            <button onclick="document.getElementById('edit_agency_form').dispatchEvent(new Event('submit'))"
                class="px-6 py-2.5 bg-brand-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2">
                <i class="ph-bold ph-floppy-disk"></i> Save Changes
            </button>
        </div>
    </div>
</div>

<div id="review-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeReviewModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-5xl flex flex-col md:flex-row overflow-hidden modal-enter h-[85vh]">

        <div
            class="w-full md:w-1/3 bg-slate-50 border-r border-slate-200 flex flex-col p-6 items-center overflow-y-auto">

            <div class="mb-6 text-center w-full">
                <div
                    class="w-32 h-32 bg-white rounded-xl border border-slate-200 shadow-sm flex items-center justify-center overflow-hidden mx-auto mb-3">
                    <img id="review-logo-img" src="" class="w-full h-full object-cover hidden">
                    <i id="review-logo-icon" class="ph-duotone ph-buildings text-4xl text-slate-300"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Agency Logo</p>
            </div>

            <div class="w-full space-y-3">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-red-50 text-red-500 flex items-center justify-center">
                            <i class="ph-fill ph-file-pdf text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-900">Trade Registry</p>
                            <p class="text-[10px] text-slate-500" id="review-rc-filename">RC_Document.pdf</p>
                        </div>
                    </div>
                    <a id="review-doc-link" href="#" target="_blank"
                        class="block w-full py-2 text-center bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800 transition-colors">
                        View Document
                    </a>
                </div>
            </div>

            <div class="mt-auto w-full pt-6 border-t border-slate-200">
                <div class="grid grid-cols-2 gap-2 text-center">
                    <div class="bg-white p-2 rounded-lg border border-slate-100">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Balance</p>
                        <p class="text-sm font-bold text-slate-900" id="review-balance">0.00</p>
                    </div>
                    <div class="bg-white p-2 rounded-lg border border-slate-100">
                        <p class="text-[10px] text-slate-400 uppercase font-bold">Limit</p>
                        <p class="text-sm font-bold text-slate-900" id="review-limit">0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-full md:w-2/3 flex flex-col bg-white">

            <div class="p-6 border-b border-slate-100 flex justify-between items-start bg-white shrink-0">
                <div>
                    <div class="flex items-center gap-3 mb-1">
                        <h2 class="text-2xl font-bold text-slate-900 leading-none" id="review-title">Agency Name</h2>
                        <span
                            class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-yellow-200">Pending</span>
                    </div>
                    <p class="text-xs text-slate-500 flex items-center gap-1">
                        Applied on <span id="review-date" class="font-medium text-slate-700">-</span>
                    </p>
                </div>
                <button onclick="closeReviewModal()" class="p-1 hover:bg-slate-100 rounded-full transition-colors">
                    <i class="ph-bold ph-x text-xl text-slate-400 hover:text-slate-600"></i>
                </button>
            </div>

            <div class="p-8 space-y-8 flex-1 overflow-y-auto">
                <input type="hidden" id="review-agency-id">

                <input type="hidden" id="store-name">
                <input type="hidden" id="store-rc">
                <input type="hidden" id="store-phone">
                <input type="hidden" id="store-city">
                <input type="hidden" id="store-address">
                <input type="hidden" id="store-limit">
                <input type="hidden" id="store-tags">

                <div>
                    <h4 class="text-xs font-bold text-slate-900 uppercase mb-4 border-b border-slate-100 pb-2">Company
                        Information</h4>
                    <div class="grid grid-cols-2 gap-y-5 gap-x-8 text-sm">
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">RC Number</label>
                            <p class="font-mono font-bold text-slate-900 bg-slate-50 px-2 py-1 rounded w-fit"
                                id="review-rc">-</p>
                        </div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Office
                                Phone</label>
                            <p class="font-medium text-slate-700" id="review-phone">-</p>
                        </div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">City</label>
                            <p class="font-medium text-slate-700" id="review-city">-</p>
                        </div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Address</label>
                            <p class="font-medium text-slate-700" id="review-address">-</p>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tags</label>
                            <div class="flex flex-wrap gap-2" id="review-tags-container"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-900 uppercase mb-4 border-b border-slate-100 pb-2">Primary
                        Manager</h4>
                    <div class="flex items-start gap-4 p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg shrink-0">
                            <i class="ph-fill ph-user"></i>
                        </div>
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[10px] text-blue-400 font-bold uppercase">Full Name</p>
                                <p class="font-bold text-slate-900" id="review-manager-name">-</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-blue-400 font-bold uppercase">Email / Username</p>
                                <p class="font-medium text-slate-700" id="review-manager-email">-</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-blue-400 font-bold uppercase">Mobile Phone</p>
                                <p class="font-medium text-slate-700" id="review-manager-phone">-</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-blue-400 font-bold uppercase">State</p>
                                <p class="font-medium text-slate-700" id="review-manager-state">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 bg-slate-50 flex gap-3 shrink-0">
                <button onclick="processReview('rejected')"
                    class="flex-1 py-3 border border-red-200 text-red-600 rounded-lg text-sm font-bold hover:bg-red-50 hover:border-red-300 transition-colors flex items-center justify-center gap-2">
                    <i class="ph-bold ph-x"></i> Reject Application
                </button>
                <button onclick="processReview('active')"
                    class="flex-[2] py-3 bg-green-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-green-700 hover:shadow-lg transition-all flex items-center justify-center gap-2">
                    <i class="ph-bold ph-check"></i> Approve & Activate
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    /* ------------------------------------------------
       1. INITIALIZATION & FILTERS
    ------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const filters = { 'status': 'filter-status', 'balance': 'filter-balance' };
        for (const [param, elementId] of Object.entries(filters)) {
            const value = params.get(param);
            const el = document.getElementById(elementId);
            if (value && el) el.value = value;
        }
    });

    /* ------------------------------------------------
       2. NEW AGENCY LOGIC
    ------------------------------------------------- */
    const newAgencyModal = document.getElementById('new_agency_modal');

    function openNewAgencyModal() {
        document.getElementById('new_agency_form').reset();
        generateUserPassword();
        newAgencyModal.classList.remove('hidden');
    }

    function closeNewAgencyModal() {
        newAgencyModal.classList.add('hidden');
    }

    function generateUserPassword() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$";
        let pass = "";
        for (let i = 0; i < 12; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('input-password').value = pass;
    }

    function submitNewAgency() {
        const form = document.getElementById('new_agency_form');
        const formData = new FormData(form);
        const btn = document.querySelector('#new_agency_modal button:last-child');
        const originalText = btn.innerText;

        btn.innerText = 'Creating...';
        btn.disabled = true;

        fetch("{% url 'agency_create' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeNewAgencyModal();
                    alert("✅ Agency Created Successfully!");
                    window.location.reload();
                } else {
                    alert("⚠️ Error: " + data.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("System Error");
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }

    /* ------------------------------------------------
       3. EDIT AGENCY LOGIC
    ------------------------------------------------- */
    const editAgencyModal = document.getElementById('edit_agency_modal');

    function openEditAgencyModal(btn) {
        document.getElementById('edit-agency-id').value = btn.dataset.id;
        document.getElementById('edit-name').value = btn.dataset.companyName;
        document.getElementById('edit-rc').value = btn.dataset.rc;
        document.getElementById('edit-phone').value = btn.dataset.phone;
        document.getElementById('edit-city').value = btn.dataset.city;
        document.getElementById('edit-address').value = btn.dataset.address;
        document.getElementById('edit-status').value = btn.dataset.status;
        document.getElementById('edit-limit').value = btn.dataset.limit.replace(/[^\d.-]/g, '');
        document.getElementById('edit-tags').value = btn.dataset.tags || '';

        // LOGO PREVIEW
        const logoImg = document.getElementById('edit-logo-preview');
        const logoPlaceholder = document.getElementById('edit-logo-placeholder');
        if (btn.dataset.logo && btn.dataset.logo !== 'None') {
            logoImg.src = btn.dataset.logo;
            logoImg.classList.remove('hidden');
            logoPlaceholder.classList.add('hidden');
        } else {
            logoImg.classList.add('hidden');
            logoPlaceholder.classList.remove('hidden');
        }

        editAgencyModal.classList.remove('hidden');
    }

    function closeEditAgencyModal() {
        editAgencyModal.classList.add('hidden');
    }

    function updateAgency() {
        const id = document.getElementById('edit-agency-id').value;
        const form = document.getElementById('edit_agency_form');
        const formData = new FormData(form);

        fetch(`/admin_panel/api/agency/update/${id}/`, {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("✅ Updated Successfully");
                    window.location.reload();
                } else {
                    alert("⚠️ Error: " + data.message);
                }
            });
    }

    /* ------------------------------------------------
       4. REVIEW MODAL LOGIC
    ------------------------------------------------- */
    const reviewModal = document.getElementById('review-modal');

    function openReviewModal(btn) {
        // UI Fields
        document.getElementById('review-agency-id').value = btn.dataset.id;
        document.getElementById('review-title').innerText = btn.dataset.name;
        document.getElementById('review-date').innerText = btn.dataset.date;
        document.getElementById('review-rc').innerText = btn.dataset.rc;
        document.getElementById('review-phone').innerText = btn.dataset.phone;
        document.getElementById('review-city').innerText = btn.dataset.city;
        document.getElementById('review-address').innerText = btn.dataset.address;
        document.getElementById('review-balance').innerText = 'DZD ' + (btn.dataset.balance || '0.00');
        document.getElementById('review-limit').innerText = 'DZD ' + (btn.dataset.limit || '0.00');

        document.getElementById('review-manager-name').innerText = btn.dataset.managerFirst + ' ' + btn.dataset.managerLast;
        document.getElementById('review-manager-email').innerText = btn.dataset.managerEmail;
        document.getElementById('review-manager-phone').innerText = btn.dataset.managerPhone;
        document.getElementById('review-manager-state').innerText = btn.dataset.managerState;

        // Hidden Storage Fields (Crucial for Update)
        document.getElementById('store-name').value = btn.dataset.name;
        document.getElementById('store-rc').value = btn.dataset.rc;
        document.getElementById('store-phone').value = btn.dataset.phone;
        document.getElementById('store-city').value = btn.dataset.city;
        document.getElementById('store-address').value = btn.dataset.address;
        document.getElementById('store-limit').value = btn.dataset.limit || 0;
        document.getElementById('store-tags').value = btn.dataset.tags || '';

        // Tags UI
        const tagsContainer = document.getElementById('review-tags-container');
        tagsContainer.innerHTML = '';
        if (btn.dataset.tags) {
            btn.dataset.tags.split(',').forEach(tag => {
                if (tag.trim()) {
                    const badge = document.createElement('span');
                    badge.className = "px-2 py-1 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200";
                    badge.innerText = tag.trim();
                    tagsContainer.appendChild(badge);
                }
            });
        }

        // Logo Logic
        const img = document.getElementById('review-logo-img');
        const icon = document.getElementById('review-logo-icon');
        if (btn.dataset.logo && btn.dataset.logo !== 'None') {
            img.src = btn.dataset.logo; img.classList.remove('hidden'); icon.classList.add('hidden');
        } else {
            img.classList.add('hidden'); icon.classList.remove('hidden');
        }

        // Doc Logic
        const docLink = document.getElementById('review-doc-link');
        const docName = document.getElementById('review-rc-filename');
        if (btn.dataset.doc && btn.dataset.doc !== 'None' && btn.dataset.doc !== '') {
            docLink.href = btn.dataset.doc;
            docLink.classList.remove('opacity-50', 'pointer-events-none', 'bg-slate-100', 'text-slate-400');
            docLink.classList.add('bg-slate-900', 'text-white', 'hover:bg-slate-800');
            docLink.innerText = "Download / View PDF";
            docName.innerText = "Document Available";
            docName.className = "text-[10px] text-green-600 font-bold";
        } else {
            docLink.href = '#';
            docLink.classList.add('opacity-50', 'pointer-events-none', 'bg-slate-100', 'text-slate-400');
            docLink.classList.remove('bg-slate-900', 'text-white', 'hover:bg-slate-800');
            docLink.innerText = "No Document Uploaded";
            docName.innerText = "Missing File";
            docName.className = "text-[10px] text-red-500 font-bold";
        }

        reviewModal.classList.remove('hidden');
    }

    function closeReviewModal() {
        reviewModal.classList.add('hidden');
    }

    function processReview(status) {
        const id = document.getElementById('review-agency-id').value;
        const formData = new FormData();

        // Append Status
        formData.append('status', status);

        // Append Stored Data (To satisfy backend requirements)
        formData.append('company_name', document.getElementById('store-name').value);
        formData.append('rc_number', document.getElementById('store-rc').value);
        formData.append('phone', document.getElementById('store-phone').value);
        formData.append('city', document.getElementById('store-city').value);
        formData.append('address', document.getElementById('store-address').value);
        formData.append('credit_limit', document.getElementById('store-limit').value);
        formData.append('tags', document.getElementById('store-tags').value);

        if (!confirm(`Are you sure you want to mark this agency as ${status.toUpperCase()}?`)) return;

        fetch(`/admin_panel/api/agency/update/${id}/`, {
            method: 'POST',
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(status === 'active' ? "✅ Agency Approved!" : "❌ Agency Rejected.");
                    window.location.reload();
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => alert("System Error: " + err));
    }

    /* ------------------------------------------------
       5. URL PARAMETER HELPER (For Pagination)
    ------------------------------------------------- */
    function updateQueryParam(key, value) {
        const url = new URL(window.location.href);
        url.searchParams.set(key, value);
        window.location.href = url.toString();
    }
</script>

{% endblock %}