{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}

<main class="flex-1 flex flex-col h-screen overflow-hidden relative">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <h1 class="text-xl font-bold text-slate-900">User Management</h1>
        <button onclick="openUserModal('new')"
            class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-slate-800 transition-colors flex items-center gap-2">
            <i class="ph-bold ph-user-plus"></i> Add New User
        </button>
    </header>

    <div class="px-8 pt-6 pb-2 bg-white border-b border-slate-200 flex flex-wrap gap-4 items-center justify-between">
        <form method="GET" class="flex-1 flex gap-4 w-full">

            <div class="relative flex-1 max-w-md">
                <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-400"></i>
                <input type="text" name="q" value="{{ search_query }}" placeholder="Search Name, Email, or Agency..."
                    class="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:outline-none focus:border-brand-500 w-full shadow-sm">
            </div>

            <div class="flex gap-3">

                <select name="role" id="filter-role" onchange="this.form.submit()"
                    class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white text-slate-600 shadow-sm cursor-pointer hover:border-slate-300">
                    <option value="">All Roles</option>
                    {% for role in roles %}
                    <option value="{{ role.id }}">{{ role.name }}</option>
                    {% endfor %}
                </select>

                <select name="agency" id="filter-agency" onchange="this.form.submit()"
                    class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white text-slate-600 shadow-sm cursor-pointer hover:border-slate-300">
                    <option value="">All Agencies</option>
                    <option value="none">Platform Staff (No Agency)</option>
                    {% for agency in agencies %}
                    <option value="{{ agency.id }}">{{ agency.company_name }}</option>
                    {% endfor %}
                </select>

                <select name="status" id="filter-status" onchange="this.form.submit()"
                    class="border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white text-slate-600 shadow-sm cursor-pointer hover:border-slate-300">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>

                {% if search_query or current_role or current_agency or current_status %}
                <a href="{% url 'user_management' %}"
                    class="px-3 py-2 text-sm text-red-500 hover:bg-red-50 rounded-lg font-medium transition-colors">Clear</a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="flex-1 overflow-y-auto p-8 bg-slate-50/50">
        <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-semibold border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-4">User Identity</th>
                        <th class="px-6 py-4">Role & Access</th>
                        <th class="px-6 py-4">Agency Affiliation</th>
                        <th class="px-6 py-4">Contact</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 text-sm">
                    {% for user in users %}
                    <tr class="hover:bg-slate-50 transition-colors group">

                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-9 h-9 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center font-bold text-xs uppercase border border-slate-300">
                                    {{ user.first_name|slice:":1" }}{{ user.last_name|slice:":1" }}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-900">{{ user.first_name }} {{ user.last_name }}
                                    </div>
                                    <div class="text-xs text-slate-500">{{ user.email }}</div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            {% if user.is_superuser %}
                            <span
                                class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-purple-200">Super
                                Admin</span>
                            {% elif user.role %}
                            <span
                                class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase border border-blue-100">
                                {{user.role.name }}</span>
                            {% else %}
                            <span
                                class="bg-slate-100 text-slate-500 px-2 py-1 rounded text-[10px] font-bold uppercase border border-slate-200">No
                                Role</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4">
                            {% if user.agency %}
                            <div class="flex items-center gap-2 text-slate-700">
                                <i class="ph-fill ph-buildings text-slate-400"></i>
                                <span class="font-medium">{{ user.agency.company_name }}</span>
                            </div>
                            {% else %}
                            <div class="flex items-center gap-2 text-slate-400">
                                <i class="ph-fill ph-globe"></i>
                                <span class="text-xs italic">Platform Staff</span>
                            </div>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 text-slate-600">
                            <div class="flex items-center gap-1.5"><i class="ph-bold ph-phone text-slate-400"></i>
                                {{user.phone }}</div>
                            <div class="flex items-center gap-1.5 mt-1 text-xs"><i
                                    class="ph-bold ph-map-pin text-slate-400"></i> {{ user.state }}</div>
                        </td>

                        <td class="px-6 py-4">
                            {% if user.is_active %}
                            <span
                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-green-50 text-green-700 border border-green-100">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Active
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-red-50 text-red-700 border border-red-100">
                                <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Inactive
                            </span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 text-right">
                            <button onclick="openUserModal('edit', '{{ user.id }}')"
                                class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded border border-transparent hover:border-blue-200 transition-all">
                                <i class="ph-bold ph-pencil-simple text-lg"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                            <i class="ph ph-users text-4xl mb-2"></i>
                            <p>No users found matching your criteria.</p>
                            {% if search_query %}
                            <a href="{% url 'user_management' %}"
                                class="text-blue-600 font-bold text-sm mt-2 hover:underline">Clear Filters</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>

<div id="user_modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeUserModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-enter">
        <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
            <h3 class="font-bold text-lg flex items-center gap-2"><i class="ph-bold ph-user"></i> <span
                    id="modal-title">Add New User</span></h3>
            <button onclick="closeUserModal()"><i class="ph-bold ph-x text-lg"></i></button>
        </div>

        <div class="p-6 overflow-y-auto max-h-[80vh]">
            <form id="user_form" onsubmit="event.preventDefault(); saveUser();" class="space-y-5">
                {% csrf_token %}
                <input type="hidden" id="user-id" name="user_id">

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">First Name *</label><input
                            type="text" name="first_name" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Last Name *</label><input
                            type="text" name="last_name" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Phone *</label><input
                            type="tel" name="phone" required
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm"></div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">State *</label>
                        <input name="state" type="text"
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white">


                    </div>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h4 class="text-xs font-bold text-slate-900 mb-3 uppercase flex items-center gap-2"><i
                            class="ph-fill ph-lock-key-open text-brand-500"></i> Access & Permissions</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Role</label>
                            <select name="role" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white">
                                <option value="">Select Role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email (Username) *</label>
                    <input type="email" name="email" required
                        class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                </div>

                <div id="password-section">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <div class="relative">
                        <input type="text" id="input-password" name="password"
                            class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono text-slate-700 bg-white">
                        <button type="button" onclick="generateUserPassword()"
                            class="absolute right-2 top-2 text-xs bg-slate-200 px-2 py-1 rounded hover:bg-slate-300 font-bold text-slate-600">Generate</button>
                    </div>
                </div>

                <div id="status-section" class="hidden pt-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="is_active" class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm text-slate-700 font-medium">User Account Active</span>
                    </label>
                </div>

                <div class="pt-4 flex gap-3 border-t border-slate-100">
                    <button type="button" onclick="closeUserModal()"
                        class="flex-1 py-2.5 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50">Cancel</button>
                    <button type="submit" id="save-btn"
                        class="flex-1 py-2.5 bg-slate-900 text-white rounded-lg text-sm font-bold shadow hover:bg-slate-800">Save
                        User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let editingUserId = null;
    const userModal = document.getElementById('user_modal');
    const userForm = document.getElementById('user_form');

    // --- 1. FILTER LOGIC ---
    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);

        const filters = {
            'role': 'filter-role',
            'agency': 'filter-agency',
            'status': 'filter-status'
        };

        for (const [param, elementId] of Object.entries(filters)) {
            const value = params.get(param);
            const element = document.getElementById(elementId);
            if (value && element) element.value = value;
        }
    });

    // --- 2. MODAL LOGIC ---
    function openUserModal(mode, id = null) {
        userForm.reset();

        if (mode === 'new') {
            editingUserId = null;
            document.getElementById('modal-title').innerText = 'Add New User';
            document.getElementById('password-section').classList.remove('hidden');
            document.getElementById('status-section').classList.add('hidden');
            generateUserPassword();
            userModal.classList.remove('hidden');
        } else {
            editingUserId = id;
            document.getElementById('modal-title').innerText = 'Edit User Details';

            // Fetch User Details from Backend
            fetch(`/admin_panel/api/user/${id}/`)
                .then(res => res.json())
                .then(data => {
                    const u = data.user;
                    userForm.querySelector('[name="first_name"]').value = u.first_name;
                    userForm.querySelector('[name="last_name"]').value = u.last_name;
                    userForm.querySelector('[name="email"]').value = u.email;
                    userForm.querySelector('[name="phone"]').value = u.phone;
                    userForm.querySelector('[name="state"]').value = u.state;
                    userForm.querySelector('[name="role"]').value = u.role_id;
                    userForm.querySelector('[name="is_active"]').checked = u.is_active;

                    // Update UI for Edit Mode
                    document.getElementById('password-section').classList.add('hidden');
                    document.getElementById('status-section').classList.remove('hidden');
                    userModal.classList.remove('hidden');
                });
        }
    }

    function closeUserModal() {
        userModal.classList.add('hidden');
    }

    // --- 3. SAVE LOGIC ---
    function saveUser() {
        const btn = document.getElementById('save-btn');
        const originalText = btn.innerText;
        btn.innerText = 'Saving...';
        btn.disabled = true;

        const formData = new FormData(userForm);

        // Ensure this URL name matches users/urls.py
        let url = "{% url 'user_create' %}";
        if (editingUserId) {
            url = `/admin_panel/api/user/update/${editingUserId}/`;
        }

        fetch(url, {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    closeUserModal();
                    alert("✅ Saved Successfully!");
                    window.location.reload();
                } else {
                    alert("⚠️ Error: " + data.message);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                alert("System Error");
                btn.innerText = originalText;
                btn.disabled = false;
            });
    }

    function generateUserPassword() {
        const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$";
        let pass = "";
        for (let i = 0; i < 12; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('input-password').value = pass;
    }
</script>
{% endblock %}