{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}

<main class="flex-1 flex flex-col h-screen overflow-hidden relative">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <h1 class="text-xl font-bold text-slate-900">Visa Processing Center</h1>
        <div class="flex items-center gap-4">
            <button onclick="openManualModal()"
                class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2">
                <i class="ph-bold ph-plus"></i> Add Manual App
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto space-y-8">

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">New</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.new }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-inbox"></i>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Under Review</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.under_review }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-inbox"></i>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Appointment Set</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.appt }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-calendar"></i>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Embassy</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.embassy }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-buildings"></i>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Completed</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.complete }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-check-circle"></i>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Rejected</p>
                        <p class="text-2xl font-bold text-slate-900">{{ stats.rejected }}</p>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-xl">
                        <i class="ph-fill ph-check-circle"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 border-b border-slate-200 flex gap-4 bg-slate-50/50">
                    <button
                        class="px-3 py-1.5 text-xs font-bold bg-white border border-slate-200 rounded shadow-sm text-slate-700">All
                        Applications</button>
                    <select
                        class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-transparent border-none outline-none cursor-pointer hover:text-slate-900">
                        <option value="">Filter by Destination</option>
                        {% for dest in destinations %}
                        <option value="{{ dest.id }}">{{ dest.country }} - {{ dest.visa_type }}</option>
                        {% endfor %}
                    </select>
                </div>

                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="text-xs font-semibold text-slate-400 uppercase border-b border-slate-200 bg-slate-50/30">
                            <th class="px-6 py-4">Reference</th>
                            <th class="px-6 py-4">Applicant</th>
                            <th class="px-6 py-4">Agency</th>
                            <th class="px-6 py-4">Destination</th>
                            <th class="px-6 py-4">Current Status</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 text-sm">
                        {% for app in applications %}
                        <tr
                            class="hover:bg-slate-50 transition-colors {% if app.status == 'new' %}bg-blue-50/20{% endif %}">
                            <td class="px-6 py-4 font-mono font-bold text-brand-600">#{{ app.reference }}</td>
                            <td class="px-6 py-4">
                                <div class="font-medium text-slate-900">{{ app.first_name }} {{ app.last_name }}</div>
                                <!-- <div class="text-xs text-slate-500">

                                </div> -->
                            </td>
                            <td class="px-6 py-4">
                                {% if app.agency %}
                                {{ app.agency.company_name }}
                                {% else %}
                                Direct Client
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    {% if app.destination.cover_image %}
                                    <img src="{{ app.destination.cover_image.url }}"
                                        class="w-6 h-4 object-cover rounded shadow-sm">
                                    {% else %}
                                    <div
                                        class="w-6 h-4 bg-slate-200 rounded flex items-center justify-center text-[8px]">
                                        üè≥Ô∏è</div>
                                    {% endif %}
                                    <span>{{ app.destination.country }}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                {% if app.status == 'new' %}
                                <span
                                    class="inline-flex items-center gap-1.5 bg-blue-100 text-blue-700 px-2.5 py-1 rounded-full text-xs font-bold">
                                    <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span> New
                                </span>
                                {% elif app.status == 'review' %}
                                <span
                                    class="bg-yellow-100 text-yellow-700 px-2.5 py-1 rounded-full text-xs font-bold border border-yellow-200">Under
                                    Review</span>
                                {% elif app.status == 'appointment' %}
                                <span
                                    class="inline-flex items-center gap-1.5 bg-purple-50 text-purple-700 px-2.5 py-1 rounded-full text-xs font-bold border border-purple-100">
                                    <i class="ph-bold ph-calendar">
                                    </i> Appt: {{ app.embassy_appointment_date|date:"M d"|default:"Set Date" }}
                                </span>
                                {% elif app.status == 'embassy' %}
                                <span
                                    class="bg-orange-100 text-orange-700 px-2.5 py-1 rounded-full text-xs font-bold border border-orange-200">At
                                    Embassy</span>
                                {% elif app.status == 'ready' %}
                                <span
                                    class="bg-teal-100 text-teal-700 px-2.5 py-1 rounded-full text-xs font-bold border border-teal-200">Ready</span>
                                {% elif app.status == 'completed' %}
                                <span
                                    class="bg-green-100 text-green-700 px-2.5 py-1 rounded-full text-xs font-bold border border-green-200">Completed</span>
                                {% elif app.status == 'rejected' %}
                                <span
                                    class="bg-red-100 text-red-700 px-2.5 py-1 rounded-full text-xs font-bold border border-red-200">Rejected</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="openProcessModal('{{ app.id }}')"
                                    class="bg-brand-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:bg-brand-700">
                                    Process
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                                <i class="ph ph-files text-4xl mb-2"></i>
                                <p>No visa applications found.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <!-- pagination -->
                <div class="p-4 border-t border-slate-200 bg-white flex items-center justify-between">

                    <div class="text-sm text-slate-500">
                        Showing <span class="font-bold text-slate-900">{{ applications.start_index }}</span>
                        to <span class="font-bold text-slate-900">{{ applications.end_index }}</span>
                        of <span class="font-bold text-slate-900">{{ applications.paginator.count }}</span> results
                    </div>

                    <div class="flex items-center gap-2">

                        {% if applications.has_previous %}
                        <a href="?page={{ applications.previous_page_number }}{% if request.GET.destination_id %}&destination_id={{ request.GET.destination_id }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors">
                            Previous
                        </a>
                        {% else %}
                        <span
                            class="px-3 py-1.5 border border-slate-100 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                            Previous
                        </span>
                        {% endif %}

                        <div class="hidden sm:flex items-center gap-1">
                            {% for num in applications.paginator.page_range %}
                            {# Logic to show only relevant page numbers (Current, First, Last, and neighbors) #}
                            {% if applications.number == num %}
                            <span
                                class="w-8 h-8 flex items-center justify-center bg-brand-600 text-white rounded-lg text-xs font-bold shadow-sm">
                                {{ num }}
                            </span>
                            {% elif num > applications.number|add:'-3' and num < applications.number|add:'3' %} <a
                                href="?page={{ num }}{% if request.GET.destination_id %}&destination_id={{ request.GET.destination_id }}{% endif %}"
                                class="w-8 h-8 flex items-center justify-center border border-slate-200 text-slate-600 rounded-lg text-xs font-bold hover:bg-slate-50 transition-colors">
                                {{ num }}
                                </a>
                                {% endif %}
                                {% endfor %}
                        </div>

                        {% if applications.has_next %}
                        <a href="?page={{ applications.next_page_number }}{% if request.GET.destination_id %}&destination_id={{ request.GET.destination_id }}{% endif %}"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors">
                            Next
                        </a>
                        {% else %}
                        <span
                            class="px-3 py-1.5 border border-slate-100 rounded-lg text-sm font-medium text-slate-300 cursor-not-allowed">
                            Next
                        </span>
                        {% endif %}

                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<div id="process-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeProcessModal()">
    </div>

    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex overflow-hidden modal-enter">

        <div class="w-7/12 bg-slate-50 border-r border-slate-200 flex flex-col p-0 overflow-y-auto">

            <div class="p-6 border-b border-slate-200 bg-white sticky top-0 z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span
                            class="text-[10px] font-bold bg-brand-100 text-brand-700 px-2 py-1 rounded uppercase tracking-wider"
                            id="view-ref">REF-LOADING</span>
                        <h2 class="text-xl font-bold text-slate-900 mt-2" id="view-applicant">Loading...</h2>
                        <div class="flex items-center gap-2 text-xs text-slate-500 mt-1">
                            <i class="ph-fill ph-buildings"></i> <span id="view-agency">-</span>
                            <span class="text-slate-300">|</span>
                            <i class="ph-fill ph-airplane-tilt"></i> <span id="view-destination">-</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Current Status</p>
                        <span id="view-status-badge"
                            class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 mt-1">
                            Loading...
                        </span>
                    </div>
                </div>
            </div>

            <div class="p-6 space-y-8">
                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-list-dashes"></i> Application Form Data
                    </h4>
                    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                                <tr>
                                    <th class="px-4 py-3 font-semibold w-1/2">Question</th>
                                    <th class="px-4 py-3 font-semibold w-1/2">Applicant Answer</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="answers-table-body">
                                <tr>
                                    <td colspan="2" class="px-4 py-4 text-center text-slate-400 italic">Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-files"></i> Attached Documents
                    </h4>
                    <div class="space-y-3" id="documents-list">
                        <div class="p-4 text-center text-slate-400 text-sm">Loading documents...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-5/12 flex flex-col bg-white">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800">Processing Actions</h3>
                <button onclick="closeProcessModal()"
                    class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-200 rounded transition-colors"><i
                        class="ph-bold ph-x text-lg"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <form id="process-form">
                    {% csrf_token %}
                    <input type="hidden" id="process-id" name="application_id">

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Update Workflow
                            Status</label>
                        <select id="status-select" name="status" onchange="toggleFields()"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm font-medium bg-white focus:ring-2 focus:ring-brand-500 outline-none shadow-sm">
                            <option value="new">New Application</option>
                            <option value="review">Under Review</option>
                            <option value="appointment">Appointment Scheduled</option>
                            <option value="embassy">Submitted to Embassy</option>
                            <option value="ready">Ready for Collection</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>

                    <div id="field-appointment"
                        class="hidden space-y-4 p-4 bg-purple-50 rounded-xl border border-purple-100 mt-4 animate-fade-in">
                        <h4 class="text-xs font-bold text-purple-700 uppercase flex items-center gap-2">
                            <i class="ph-fill ph-calendar-plus"></i> Set Appointment
                        </h4>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1">Date & Time</label>
                            <input type="datetime-local" id="process-appt-date" name="embassy_appointment_date"
                                class="w-full border border-purple-200 rounded p-2 text-sm bg-white focus:outline-none focus:border-purple-400">
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Internal Notes</label>
                        <textarea id="process-notes" name="admin_notes"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm h-32 resize-none focus:ring-2 focus:ring-brand-500 shadow-sm"
                            placeholder="Write internal remarks here (e.g. 'Pending payment', 'Missing signature')..."></textarea>
                    </div>
                </form>
            </div>

            <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                <button onclick="closeProcessModal()"
                    class="px-5 py-2.5 border border-slate-300 bg-white rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
                <button onclick="saveProcessChanges()"
                    class="px-6 py-2.5 bg-brand-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 flex items-center gap-2 transition-transform active:scale-95">
                    <i class="ph-bold ph-floppy-disk"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<div id="destination-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDestinationModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden modal-enter flex flex-col h-[80vh]">

        <div class="p-6 border-b border-slate-200 bg-white shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-slate-900">Select Visa Destination</h3>
                <button onclick="closeDestinationModal()"
                    class="p-1 hover:bg-slate-100 rounded-full transition-colors text-slate-500 hover:text-slate-800">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="relative group">
                <i
                    class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                <input type="text" id="dest-search" onkeyup="filterDestinations()"
                    placeholder="Search Country (e.g. France, Turkey)..."
                    class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none transition-all shadow-sm">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative">

            <div id="dest-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>

            <div id="dest-loading"
                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-50/80 z-10">
                <i class="ph-bold ph-spinner animate-spin text-3xl text-brand-500 mb-2"></i>
                <p class="text-slate-500 text-sm font-medium">Loading available visas...</p>
            </div>

            <div id="dest-empty" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <i class="ph-duotone ph-airplane-tilt text-3xl"></i>
                </div>
                <p class="text-sm font-medium">No destinations found matching your search.</p>
            </div>
        </div>

        <div
            class="p-4 border-t border-slate-200 bg-white flex justify-between items-center text-sm text-slate-500 shrink-0">
            <span id="dest-count-display" class="font-medium">Showing 0 destinations</span>
            <div class="flex gap-2">
                <button id="btn-prev" onclick="changePage(-1)" disabled
                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Previous</button>
                <button id="btn-next" onclick="changePage(1)" disabled
                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Next</button>
            </div>
        </div>
    </div>
</div>

<div id="manual-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeManualModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden modal-enter">

        <div class="bg-brand-600 p-4 flex justify-between items-center text-white shrink-0 shadow-md z-10">
            <div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] uppercase font-bold text-brand-200 tracking-wider">New Application</span>
                    <span id="display-form-version"
                        class="bg-brand-700 text-[10px] px-1.5 rounded text-white font-mono opacity-80">v--</span>
                </div>
                <h3 class="font-bold text-lg flex items-center gap-2 mt-0.5" id="selected-dest-title">
                    <i class="ph-fill ph-airplane-tilt"></i> Loading...
                </h3>
            </div>
            <button onclick="closeManualModal()"
                class="text-brand-100 hover:text-white p-1 rounded hover:bg-brand-500 transition-colors">
                <i class="ph-bold ph-x text-lg"></i>
            </button>
        </div>

        <form id="create-visa-form" method="POST" action="{% url 'visa_create' %}" enctype="multipart/form-data"
            class="flex-1 flex flex-col overflow-hidden">
            {% csrf_token %}
            <input type="hidden" id="hidden-dest-id" name="destination">

            <div class="flex-1 overflow-y-auto p-8 space-y-8 bg-slate-50/50">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-5 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-2">1.
                            Applicant Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">First Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="first_name" required
                                    class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Last Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="last_name" required
                                    class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Passport Number <span
                                    class="text-red-500">*</span></label>
                            <input type="text" name="passport_number" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono uppercase focus:ring-2 focus:ring-brand-500 transition-all">
                        </div>
                        <div class="relative group">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign Agency</label>

                            <input type="hidden" id="real-agency-id" name="agency" value="">

                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="agency-search-input"
                                    placeholder="Search Agency or 'Direct Client'..." onkeyup="filterAgencies()"
                                    onfocus="showAgencyDropdown()"
                                    class="w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-slate-50 focus:bg-white transition-colors"
                                    autocomplete="off">

                                <button type="button" onclick="selectAgency('', 'Direct Client (Walk-in)')"
                                    class="absolute right-2 top-2 text-slate-400 hover:text-slate-600 p-1"
                                    title="Reset to Direct Client">
                                    <i class="ph-bold ph-x-circle"></i>
                                </button>
                            </div>

                            <div id="agency-dropdown-list"
                                class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto z-50 divide-y divide-slate-50">

                                <div id="agency-list-container"></div>

                                <div id="agency-loading" class="hidden p-4 text-center text-slate-400">
                                    <i class="ph-bold ph-spinner animate-spin"></i> Loading...
                                </div>

                                <div id="no-agencies-found"
                                    class="hidden p-4 text-center text-xs text-slate-400 italic">
                                    No agencies found.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="schema-loading"
                        class="hidden flex flex-col items-center justify-center h-full text-center p-8">
                        <i class="ph-bold ph-spinner animate-spin text-3xl text-brand-500 mb-3"></i>
                        <p class="text-sm font-bold text-slate-500">Retrieving latest form requirements...</p>
                    </div>

                    <div id="docs-section"
                        class="hidden space-y-5 bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                        <h4
                            class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-files"></i> 2. Required Documents
                        </h4>
                        <div id="dynamic-docs-container" class="space-y-4"></div>
                    </div>
                </div>

                <div id="fields-section"
                    class="hidden bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                    <h4
                        class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-4 flex items-center gap-2">
                        <i class="ph-bold ph-list-dashes"></i> 3. Visa Application Form
                    </h4>
                    <div class="overflow-hidden rounded-lg border border-slate-100">
                        <table class="w-full text-left text-sm">
                            <thead
                                class="bg-slate-50 text-xs text-slate-500 font-semibold uppercase border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3 w-1/3">Question</th>
                                    <th class="px-6 py-3 w-2/3">Applicant Answer</th>
                                </tr>
                            </thead>
                            <tbody id="dynamic-fields-container" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-slate-200 flex justify-between items-center shrink-0 z-10">
                <button type="button" onclick="backToDestinations()"
                    class="text-sm font-bold text-slate-500 hover:text-slate-700 flex items-center gap-1 group">
                    <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Change
                    Destination
                </button>
                <div class="flex gap-3">
                    <button type="button" onclick="closeManualModal()"
                        class="px-5 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                        <i class="ph-bold ph-paper-plane-right"></i> Submit Application
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    // === PROCESS MODAL LOGIC (AJAX POWERED) ===
    const processModal = document.getElementById('process-modal');
    const statusSelect = document.getElementById('status-select');
    const fieldAppt = document.getElementById('field-appointment');
    const status_badge = document.getElementById('view-status-badge');

    // --- Status Labels & Colors ---
    const STATUS_LABELS = {
        new: "New Application",
        review: "Under Review",
        appointment: "Appointment Scheduled",
        embassy: "Submitted to Embassy",
        ready: "Ready for Collection",
        completed: "Completed",
        rejected: "Rejected"
    };

    const STATUS_COLORS = {
        new: "bg-blue-100 text-blue-600",
        review: "bg-yellow-100 text-yellow-600",
        appointment: "bg-purple-100 text-purple-600",
        embassy: "bg-orange-100 text-orange-600",
        ready: "bg-green-100 text-green-600",
        completed: "bg-indigo-100 text-indigo-600",
        rejected: "bg-red-100 text-red-600"
    };

    // === 1. OPEN MODAL & FETCH DATA ===
    function openProcessModal(appId) {
        processModal.classList.remove('hidden');

        document.getElementById('view-ref').innerText = 'LOADING...';
        document.getElementById('view-applicant').innerText = 'Fetching Data...';
        document.getElementById('answers-table-body').innerHTML = '<tr><td colspan="2" class="px-4 py-8 text-center"><i class="ph-bold ph-spinner animate-spin text-2xl text-brand-600"></i></td></tr>';
        document.getElementById('documents-list').innerHTML = '';

        fetch(`/admin_panel/api/visa/${appId}/`)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => populateModalData(data))
            .catch(error => {
                console.error('Error:', error);
                alert("Failed to load application data. Please try again.");
                closeProcessModal();
            });
    }

    // === 2. POPULATE DATA ===
    function populateModalData(data) {
        // Header Info
        document.getElementById('process-id').value = data.id;
        document.getElementById('view-ref').innerText = '#' + data.reference;
        document.getElementById('view-applicant').innerText = data.applicant;
        document.getElementById('view-agency').innerText = data.agency_name || 'Direct Client';
        document.getElementById('view-destination').innerText = data.destination || 'Unknown';

        // --- Status ---
        if (statusSelect.querySelector(`option[value="${data.status}"]`)) {
            statusSelect.value = data.status;
        } else {
            console.warn("Unknown status from API:", data.status);
            statusSelect.value = "new";
        }

        // Update badge to match select
        updateStatusBadge(statusSelect.value);

        // Show/hide fields if needed
        toggleFields();

        // Listen for user changes in select (live badge update)
        statusSelect.onchange = () => {
            updateStatusBadge(statusSelect.value);
            toggleFields();
        };

        // Notes
        document.getElementById('process-notes').value = data.admin_notes || '';
        if (data.appointment_date) {
            document.getElementById('process-appt-date').value = data.appointment_date;
        }

        // --- Answers Table ---
        const tableBody = document.getElementById('answers-table-body');
        tableBody.innerHTML = '';
        if (data.answers?.length > 0) {
            data.answers.forEach(ans => {
                tableBody.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3 border-b border-slate-100 font-medium text-slate-600">${ans.label}</td>
                        <td class="px-4 py-3 border-b border-slate-100 font-bold text-slate-900">${ans.value}</td>
                    </tr>
                `);
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="2" class="px-4 py-4 text-center text-slate-400 italic">No additional form data provided.</td></tr>';
        }

        // --- Documents List ---
        const docsContainer = document.getElementById('documents-list');
        docsContainer.innerHTML = '';
        if (data.documents?.length > 0) {
            data.documents.forEach(doc => {
                let statusColor = 'bg-slate-100 text-slate-600';
                if (doc.status === 'valid') statusColor = 'bg-green-100 text-green-600';
                if (doc.status === 'rejected') statusColor = 'bg-red-100 text-red-600';

                docsContainer.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200 shadow-sm group hover:border-brand-300 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg ${statusColor} flex items-center justify-center text-lg">
                                <i class="ph-fill ph-file-pdf"></i>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-700">${doc.name}</p>
                                <p class="text-[10px] text-slate-400 uppercase font-bold">${doc.status}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-100">
                            <a href="${doc.url}" target="_blank" class="p-2 text-slate-500 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors" title="View File">
                                <i class="ph-bold ph-eye"></i>
                            </a>
                        </div>
                    </div>
                `);
            });
        } else {
            docsContainer.innerHTML = '<div class="p-4 border border-dashed border-slate-300 rounded-lg text-center text-slate-400 text-sm">No documents uploaded.</div>';
        }
    }

    // === 3. UTILITIES ===
    function closeProcessModal() { processModal.classList.add('hidden'); }

    function toggleFields() {
        const val = statusSelect.value;
        if (val === 'appointment') {
            fieldAppt.classList.remove('hidden');
        } else {
            fieldAppt.classList.add('hidden');
        }
    }

    function updateStatusBadge(status) {
        status_badge.className = `inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold mt-1 ${STATUS_COLORS[status] || 'bg-slate-100 text-slate-600'}`;
        status_badge.textContent = STATUS_LABELS[status] || status;
    }

    function saveProcessChanges() {
        const btn = document.querySelector('#process-modal button:last-child');
        const originalText = btn.innerHTML;
        const form = document.getElementById('process-form');

        // 1. UI Loading State
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
        btn.disabled = true;

        // 2. Prepare Data
        const formData = new FormData(form);

        // 3. Send Request
        fetch("{% url 'api_visa_update' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("Updated Successfully!");
                    closeProcessModal();
                    window.location.reload(); // Refresh table to see new status
                } else {
                    // Handle Validation Errors
                    alert("Error: " + (data.message || "Unknown error"));
                    console.error(data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Server connection failed.");
            })
            .finally(() => {
                // Reset Button
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
</script>
<script>
    // ==========================================
    // 1. GLOBAL VARIABLES & CACHE
    // ==========================================
    let allDestinations = [];
    let filteredDestinations = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    // DOM Elements
    const destModal = document.getElementById('destination-modal');
    const manualModal = document.getElementById('manual-modal');
    const destGrid = document.getElementById('dest-grid');
    const destLoading = document.getElementById('dest-loading');
    const destEmpty = document.getElementById('dest-empty');

    // ==========================================
    // 2. MODAL 1: DESTINATION SELECTION
    // ==========================================

    // Triggered by the "Add Manual Application" button
    function openManualModal() {
        destModal.classList.remove('hidden');

        // Only fetch if we haven't already (Cache)
        if (allDestinations.length === 0) {
            destLoading.classList.remove('hidden');

            // Fetch from the API
            fetch("{% url 'api_visa_destinations' %}")
                .then(res => {
                    if (!res.ok) throw new Error("API Error");
                    return res.json();
                })
                .then(data => {
                    allDestinations = data.destinations;
                    filteredDestinations = [...allDestinations];
                    renderDestinations();
                })
                .catch(err => {
                    console.error(err);
                    destGrid.innerHTML = `<div class="col-span-2 text-center text-red-500 py-8">Failed to load destinations. Please refresh.</div>`;
                })
                .finally(() => {
                    destLoading.classList.add('hidden');
                });
        } else {
            // Data exists, just reset view
            document.getElementById('dest-search').value = '';
            filteredDestinations = [...allDestinations];
            currentPage = 1;
            renderDestinations();
        }
    }

    function closeDestinationModal() {
        destModal.classList.add('hidden');
    }

    // Filter Logic
    function filterDestinations() {
        const query = document.getElementById('dest-search').value.toLowerCase();
        filteredDestinations = allDestinations.filter(d =>
            d.country.toLowerCase().includes(query) ||
            d.visa_type.toLowerCase().includes(query)
        );
        currentPage = 1;
        renderDestinations();
    }

    // Pagination Logic
    function changePage(direction) {
        currentPage += direction;
        renderDestinations();
    }

    // Render Grid Logic
    function renderDestinations() {
        destGrid.innerHTML = '';
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredDestinations.slice(start, end);

        // Update UI Counters
        const total = filteredDestinations.length;
        const showingCount = Math.min(end, total);

        document.getElementById('dest-count-display').innerText = total > 0
            ? `Showing ${start + 1}-${showingCount} of ${total} destinations`
            : `Showing 0 destinations`;

        document.getElementById('btn-prev').disabled = (currentPage === 1);
        document.getElementById('btn-next').disabled = (end >= total);

        if (pageItems.length === 0) {
            destEmpty.classList.remove('hidden');
            return;
        } else {
            destEmpty.classList.add('hidden');
        }

        pageItems.forEach(dest => {
            // NOTE: We pass ID, Country, AND Type here so the next modal knows what to display
            const card = `
                <div onclick="selectDestination(${dest.id}, '${dest.country}', '${dest.visa_type}')" 
                     class="group bg-white border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-brand-500 hover:shadow-md transition-all relative overflow-hidden">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl border border-slate-200">üè≥Ô∏è</div>
                            <div>
                                <h4 class="font-bold text-slate-900 group-hover:text-brand-700">${dest.country}</h4>
                                <p class="text-xs text-slate-500 font-medium">${dest.visa_type}</p>
                            </div>
                        </div>
                        <span class="bg-slate-100 text-slate-700 text-xs font-bold px-2.5 py-1 rounded">DZD ${dest.selling_price}</span>
                    </div>
                     <div class="flex items-center gap-4 text-[11px] text-slate-500 mt-3 border-t border-slate-50 pt-3">
                        <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-0.5 rounded">
                            <i class="ph-bold ph-clock text-slate-400"></i> ${dest.processing_time}
                        </span>
                        <span class="flex items-center gap-1.5 text-brand-600 font-bold ml-auto opacity-0 group-hover:opacity-100 transition-opacity">
                            Select <i class="ph-bold ph-arrow-right"></i>
                        </span>
                    </div>
                </div>
            `;
            destGrid.insertAdjacentHTML('beforeend', card);
        });
    }


    // ==========================================
    // 3. THE BRIDGE: SWITCHING MODALS
    // ==========================================

    function selectDestination(id, country, type) {
        // A. Close Destination Modal
        closeDestinationModal();

        // B. Open Application Modal
        if (manualModal) {
            manualModal.classList.remove('hidden');
        } else {
            console.error("Error: manual-modal div not found in DOM");
            return;
        }

        // C. Update Header & Hidden Input
        // This puts the country name in the header of the second modal
        document.getElementById('selected-dest-title').innerHTML = `<i class="ph-fill ph-airplane-tilt"></i> ${country} <span class="opacity-50 mx-2">|</span> ${type}`;
        document.getElementById('hidden-dest-id').value = id;

        // D. Trigger Data Load (Fetch schema from DB)
        loadVisaSchema(id);
    }

    function closeManualModal() {
        manualModal.classList.add('hidden');
    }

    function backToDestinations() {
        closeManualModal();
        openManualModal();
    }


    // ==========================================
    // 4. DATA LOADER (SCHEMA FETCHER)
    // ==========================================

    function loadVisaSchema(destId) {
        const loading = document.getElementById('schema-loading');
        const formSection = document.getElementById('fields-section');
        const docSection = document.getElementById('docs-section');

        // Reset UI before fetch
        loading.classList.remove('hidden');
        formSection.classList.add('hidden');
        docSection.classList.add('hidden');

        fetch(`/admin_panel/api/visa/schema/${destId}/`)
            .then(res => res.json())
            .then(data => {
                // 1. Header Version Info
                const verDisplay = document.getElementById('display-form-version');
                if (verDisplay) verDisplay.innerText = data.form_version;

                // 2. Render Fields
                const fieldsContainer = document.getElementById('dynamic-fields-container');
                if (data.fields.length > 0) {
                    const rows = data.fields.map(field => {
                        let inputHtml = '';
                        const reqAttr = field.required ? 'required' : '';

                        if (field.type === 'select') {
                            const opts = (Array.isArray(field.options) ? field.options : String(field.options || '').split(/,|\n/)).map(o => String(o).trim()).filter(o => o).map(o => `<option value="${o}">${o}</option>`).join('');
                            inputHtml = `<select name="field_${field.id}" ${reqAttr} class="w-full border border-slate-300 rounded p-2 text-sm bg-slate-50 focus:bg-white"><option value="">Select...</option>${opts}</select>`;

                        } else if (field.type === 'date') {
                            inputHtml = `<input type="date" name="field_${field.id}" ${reqAttr} class="w-full border border-slate-300 rounded p-2 text-sm bg-slate-50 focus:bg-white">`;
                        } else if (field.type === 'checkbox') {
                            inputHtml = `<label class="flex items-center gap-2"><input type="checkbox" name="field_${field.id}" value="Yes" class="w-5 h-5 text-brand-600 rounded"> <span class="text-sm">Yes</span></label>`;
                        } else {
                            inputHtml = `<input type="text" name="field_${field.id}" ${reqAttr} class="w-full border border-slate-300 rounded p-2 text-sm bg-slate-50 focus:bg-white">`;
                        }

                        return `
                            <tr>
                                <td class="px-6 py-3 text-sm font-medium text-slate-700 w-1/3">
                                    ${field.label} ${field.required ? '<span class="text-red-500">*</span>' : ''}
                                </td>
                                <td class="px-6 py-3 w-2/3">${inputHtml}</td>
                            </tr>
                        `;
                    }).join('');
                    fieldsContainer.innerHTML = rows;
                    formSection.classList.remove('hidden');
                } else {
                    fieldsContainer.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">No extra questions required.</td></tr>';
                    formSection.classList.remove('hidden');
                }

                // 3. Render Documents
                const docsContainer = document.getElementById('dynamic-docs-container');
                if (data.documents.length > 0) {
                    const docs = data.documents.map(doc => `
                        <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg bg-slate-50 hover:bg-white transition-colors">
                            <div>
                                <p class="text-sm font-bold text-slate-700">${doc.name}</p>
                                <p class="text-[10px] text-slate-500">${doc.description || 'Required'}</p>
                            </div>
                            <input type="file" name="doc_${doc.id}" class="text-xs text-slate-500">
                        </div>
                    `).join('');
                    docsContainer.innerHTML = docs;
                    docSection.classList.remove('hidden');
                } else {
                    docsContainer.innerHTML = '<p class="text-sm text-slate-400 italic">No documents required.</p>';
                    docSection.classList.remove('hidden');
                }

                loading.classList.add('hidden');
            })
            .catch(err => {
                console.error(err);
                loading.innerHTML = '<p class="text-red-500 text-center font-bold">Error loading requirements.</p>';
            });
    }
    // ==========================================
    // 5. AGENCY SEARCH DROPDOWN LOGIC (API)
    // ==========================================

    let agenciesLoaded = false; // Cache flag
    const agencyDropdown = document.getElementById('agency-dropdown-list');
    const agencyContainer = document.getElementById('agency-list-container');
    const agencyLoading = document.getElementById('agency-loading');
    const agencyInput = document.getElementById('agency-search-input');
    const realAgencyInput = document.getElementById('real-agency-id');
    const noAgenciesMsg = document.getElementById('no-agencies-found');

    function showAgencyDropdown() {
        agencyDropdown.classList.remove('hidden');

        // Fetch only if we haven't loaded them yet
        if (!agenciesLoaded) {
            fetchAgencies();
        }
    }

    function fetchAgencies() {
        agencyLoading.classList.remove('hidden');

        fetch("{% url 'api_agencies' %}")
            .then(res => res.json())
            .then(data => {
                renderAgencies(data.agencies);
                agenciesLoaded = true; // Mark as loaded
            })
            .catch(err => {
                console.error("Error loading agencies:", err);
                agencyContainer.innerHTML = `<div class="p-2 text-center text-red-500 text-xs">Failed to load</div>`;
            })
            .finally(() => {
                agencyLoading.classList.add('hidden');
            });
    }

    function renderAgencies(list) {
        if (list.length === 0) return;

        const html = list.map(agency => `
            <div onclick="selectAgency('${agency.id}', '${agency.company_name.replace(/'/g, "\\'")}')" 
                 class="agency-option p-3 hover:bg-brand-50 cursor-pointer flex items-center gap-3 transition-colors"
                 data-name="${agency.company_name.toLowerCase()}">
                <div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600">
                    <i class="ph-fill ph-buildings"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-slate-700">${agency.company_name}</p>
                    <p class="text-[10px] text-slate-400">Balance: DZD ${agency.balance}</p>
                </div>
            </div>
        `).join('');

        agencyContainer.innerHTML = html;
    }

    function filterAgencies() {
        const query = agencyInput.value.toLowerCase();
        const options = document.querySelectorAll('.agency-option');
        let hasVisible = false;

        options.forEach(option => {
            const name = option.getAttribute('data-name');
            if (name.includes(query)) {
                option.classList.remove('hidden');
                hasVisible = true;
            } else {
                option.classList.add('hidden');
            }
        });

        if (!hasVisible) {
            noAgenciesMsg.classList.remove('hidden');
        } else {
            noAgenciesMsg.classList.add('hidden');
        }
    }

    function selectAgency(id, name) {
        // Set Values
        realAgencyInput.value = id;
        agencyInput.value = name;

        // Close Dropdown
        agencyDropdown.classList.add('hidden');

        // Visual Feedback
        if (id) {
            agencyInput.classList.add('border-brand-500', 'bg-brand-50/50');
            agencyInput.classList.remove('border-slate-300', 'bg-slate-50');
        } else {
            // Direct Client style
            agencyInput.classList.remove('border-brand-500', 'bg-brand-50/50');
            agencyInput.classList.add('border-slate-300', 'bg-slate-50');
        }
    }

    // Close on click outside
    document.addEventListener('click', function (e) {
        const wrapper = agencyInput.closest('.group');
        if (!wrapper.contains(e.target)) {
            agencyDropdown.classList.add('hidden');
        }
    });
</script>

<!-- form -->
<script>
    document.getElementById('create-visa-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const btn = e.submitter; // The submit button
        const originalText = btn.innerHTML;
        const form = e.target;
        const formData = new FormData();

        // 1. UI Loading State
        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
        btn.disabled = true;

        // 2. Prepare Structure
        const payload = {
            main_info: {
                first_name: form.querySelector('[name="first_name"]').value,
                last_name: form.querySelector('[name="last_name"]').value,
                passport_number: form.querySelector('[name="passport_number"]').value,
                destination: document.getElementById('hidden-dest-id').value,
                agency_id: parseInt(document.getElementById('real-agency-id').value) || null
            },
            answers: []
        };

        // 3. Client-side Validation (Strict Agency Check)
        if (!payload.main_info.agency_id) {
            alert("Please select a valid Agency.");
            btn.innerHTML = originalText;
            btn.disabled = false;
            return; // Stop here if no agency
        }

        // 4. Collect Answers
        const dynamicInputs = form.querySelectorAll('[name^="field_"]');
        dynamicInputs.forEach(input => {
            const fieldId = input.name.split('_')[1];
            payload.answers.push({
                field_id: fieldId,
                value: input.type === 'checkbox' ? (input.checked ? 'Yes' : 'No') : input.value
            });
        });

        formData.append('json_data', JSON.stringify(payload));

        // 5. Collect Files
        const fileInputs = form.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            if (input.files.length > 0) {
                formData.append(input.name, input.files[0]);
            }
        });

        // 6. Send Request
        fetch("{% url 'visa_create' %}", {
            method: 'POST',
            body: formData,
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.json()) // Always expect JSON now
            .then(data => {
                if (data.status === 'success') {
                    // === FIX IS HERE ===
                    // Close modal immediately so it doesn't get stuck
                    closeManualModal();

                    // Then redirect
                    window.location.href = data.redirect_url;
                } else {
                    // Show Error
                    alert("Error: " + (data.message || "Unknown error"));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("System Error. Please check console.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    });
</script>

<!-- pagination -->
<script>
    // Add this inside your main <script> tag

    // Find the filter dropdown (Add id="table-filter-dest" to your select element first!)
    const filterSelect = document.getElementById('table-filter-dest');

    if (filterSelect) {
        filterSelect.addEventListener('change', function () {
            const destId = this.value;
            const currentUrl = new URL(window.location.href);

            if (destId) {
                currentUrl.searchParams.set('destination_id', destId);
            } else {
                currentUrl.searchParams.delete('destination_id');
            }

            // Reset to page 1 when filtering
            currentUrl.searchParams.set('page', '1');

            window.location.href = currentUrl.toString();
        });
    }
</script>
{% endblock %}