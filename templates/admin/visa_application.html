{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}

<main class="flex-1 flex flex-col h-screen overflow-hidden relative">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
        <h1 class="text-xl font-bold text-slate-900">Visa Processing Center</h1>

        <div class="flex items-center gap-4">
            <div class="relative group">
                <i
                    class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-slate-400 group-focus-within:text-brand-500"></i>
                <input type="text" id="admin-search" oninput="debounceLoad()"
                    placeholder="Search ref, applicant, agency..."
                    class="pl-10 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-brand-500 w-64 transition-all">
            </div>

            <button onclick="openManualModal()"
                class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 transition-colors flex items-center gap-2">
                <i class="ph-bold ph-plus"></i> Add Manual App
            </button>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto space-y-8">

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

                <div onclick="setFilterStatus('new')" id="card-new"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">New</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-new">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-plus-circle"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('review')" id="card-review"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Under Review</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-review">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-magnifying-glass"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('appointment')" id="card-appointment"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Appointment Set</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-appt">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-calendar-check"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('embassy')" id="card-embassy"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Embassy</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-embassy">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-buildings"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('ready')" id="card-ready"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Ready</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-ready">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-package"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('completed')" id="card-completed"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Completed</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-completed">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-check-circle"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('rejected')" id="card-rejected"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Rejected</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-rejected">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-red-50 text-red-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-warning-circle"></i>
                        </div>
                    </div>
                </div>

                <div onclick="setFilterStatus('cancelled')" id="card-cancelled"
                    class="stat-card bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Cancelled</p>
                            <p class="text-2xl font-bold text-slate-900 mt-1" id="stat-cancelled">-</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center text-xl">
                            <i class="ph-fill ph-x-circle"></i>
                        </div>
                    </div>
                </div>

            </div>

            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div
                    class="p-4 border-b border-slate-200 flex flex-col md:flex-row gap-4 bg-slate-50/50 justify-between">

                    <div class="flex gap-2">
                        <button onclick="setFilterStatus('all')"
                            class="px-3 py-1.5 text-xs font-bold bg-white border border-slate-200 rounded shadow-sm text-slate-700 hover:bg-slate-50 transition-colors">
                            All Applications
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <select id="filter-destination" onchange="loadAdminData()"
                            class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-white border border-slate-200 rounded-lg outline-none cursor-pointer hover:text-slate-900">
                            <option value="">Filter by Destination</option>
                        </select>
                        <button onclick="loadAdminData()"
                            class="p-1.5 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 text-slate-500"><i
                                class="ph-bold ph-arrow-clockwise"></i></button>
                    </div>
                </div>

                <table class="w-full text-left border-collapse">
                    <thead
                        class="text-xs font-semibold text-slate-400 uppercase border-b border-slate-200 bg-slate-50/30">
                        <tr>
                            <th class="px-6 py-4">Reference</th>
                            <th class="px-6 py-4">Applicant</th>
                            <th class="px-6 py-4">Agency</th>
                            <th class="px-6 py-4">Destination</th>
                            <th class="px-6 py-4">Current Status</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="divide-y divide-slate-100 text-sm">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-slate-400">Loading data...</td>
                        </tr>
                    </tbody>
                </table>

                <div class="p-4 border-t border-slate-200 bg-white flex items-center justify-between"
                    id="pagination-container">
                    <span class="text-xs text-slate-500" id="page-info">Showing - results</span>
                    <div class="flex gap-2">
                        <button id="btn-prev" onclick="changePage(-1)"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Previous</button>
                        <button id="btn-next" onclick="changePage(1)"
                            class="px-3 py-1.5 border border-slate-300 rounded-lg text-xs font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">Next</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<div id="process-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeProcessModal()">
    </div>

    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] flex overflow-hidden modal-enter">

        <div class="w-7/12 bg-slate-50 border-r border-slate-200 flex flex-col p-0 overflow-y-auto">

            <div class="p-6 border-b border-slate-200 bg-white sticky top-0 z-10">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <span
                            class="text-[10px] font-bold bg-brand-100 text-brand-700 px-2 py-1 rounded uppercase tracking-wider"
                            id="view-ref">REF-LOADING</span>
                        <h2 class="text-xl font-bold text-slate-900 mt-2" id="view-applicant">Loading...</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Applied by
                            <span class="font-semibold text-slate-700" id="view-applied-by">‚Äî</span>
                        </p>
                        <div class="flex items-center gap-2 text-xs text-slate-500 mt-1">
                            <i class="ph-fill ph-buildings"></i> <span id="view-agency">-</span>
                            <span class="text-slate-300">|</span>
                            <i class="ph-fill ph-airplane-tilt"></i> <span id="view-destination">-</span>
                        </div>
                    </div>
                    <div class="text-right space-y-2">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Current Status</p>
                            <span id="view-status-badge"
                                class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 mt-1">
                                Loading...
                            </span>
                        </div>

                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Master Agent</p>
                            <p id="view-master-agent" class="text-xs font-semibold text-slate-700">
                                ‚Äî
                            </p>
                        </div>
                    </div>

                </div>
            </div>

            <div class="p-6 space-y-8">
                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-list-dashes"></i> Application Form Data
                    </h4>
                    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                                <tr>
                                    <th class="px-4 py-3 font-semibold w-1/2">Question</th>
                                    <th class="px-4 py-3 font-semibold w-1/2">Applicant Answer</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="answers-table-body">
                                <tr>
                                    <td colspan="2" class="px-4 py-4 text-center text-slate-400 italic">Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-files"></i> Attached Documents
                    </h4>
                    <div class="space-y-3" id="documents-list">
                        <div class="p-4 text-center text-slate-400 text-sm">Loading documents...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="w-5/12 flex flex-col bg-white">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800">Processing Actions</h3>
                <button onclick="closeProcessModal()"
                    class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-200 rounded transition-colors"><i
                        class="ph-bold ph-x text-lg"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <form id="process-form">
                    {% csrf_token %}
                    <input type="hidden" id="process-id" name="application_id">

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Update Workflow
                            Status</label>
                        <select id="status-select" name="status" onchange="toggleFields()"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm font-medium bg-white focus:ring-2 focus:ring-brand-500 outline-none shadow-sm">
                            <option value="new">New Application</option>
                            <option value="review">Under Review</option>
                            <option value="appointment">Appointment Scheduled</option>
                            <option value="embassy">Submitted to Embassy</option>
                            <option value="ready">Ready for Collection</option>
                            <option value="completed">Completed</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

                    <div id="field-appointment"
                        class="hidden space-y-4 p-4 bg-purple-50 rounded-xl border border-purple-100 mt-4 animate-fade-in">
                        <h4 class="text-xs font-bold text-purple-700 uppercase flex items-center gap-2">
                            <i class="ph-fill ph-calendar-plus"></i> Set Appointment
                        </h4>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-600 mb-1">Date & Time</label>
                            <input type="datetime-local" id="process-appt-date" name="embassy_appointment_date"
                                class="w-full border border-purple-200 rounded p-2 text-sm bg-white focus:outline-none focus:border-purple-400">
                        </div>
                    </div>

                    <div id="field-visa-upload"
                        class="hidden space-y-4 p-4 bg-green-50 rounded-xl border border-green-100 mt-4 animate-fade-in">

                        <h4 class="text-xs font-bold text-green-700 uppercase flex items-center gap-2">
                            <i class="ph-bold ph-file-pdf"></i> Upload Final Visa
                        </h4>

                        <div id="existing-visa-badge"
                            class="hidden flex items-center gap-2 text-xs text-green-700 bg-white px-3 py-2 rounded-lg border border-green-200 shadow-sm mb-2">
                            <i class="ph-fill ph-check-circle text-lg text-green-600"></i>
                            <span class="font-semibold">Visa Already Uploaded</span>
                            <span class="text-green-300">|</span>
                            <a id="existing-visa-link" href="#" target="_blank"
                                class="font-bold underline decoration-green-300 hover:text-green-900 transition-colors">
                                View File
                            </a>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-green-600 mb-2">
                                Attach Scanned Visa (PDF or Image)
                            </label>

                            <div class="relative group">
                                <input type="file" name="visa_doc" id="visa_doc_input" accept=".pdf, .jpg, .jpeg, .png"
                                    class="block w-full text-xs text-slate-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-xs file:font-semibold
                              file:bg-green-100 file:text-green-700
                              hover:file:bg-green-200
                              cursor-pointer">
                            </div>
                            <p class="text-[10px] text-green-600/70 mt-1 italic">
                                * Uploading this will allow the client to download their visa immediately.
                            </p>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Internal Notes</label>
                        <textarea id="process-notes" name="admin_notes"
                            class="w-full border border-slate-300 rounded-lg p-3 text-sm h-32 resize-none focus:ring-2 focus:ring-brand-500 shadow-sm"
                            placeholder="Write internal remarks here..."></textarea>
                    </div>
                </form>
            </div>

            <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                <button onclick="closeProcessModal()"
                    class="px-5 py-2.5 border border-slate-300 bg-white rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
                <button onclick="saveProcessChanges()"
                    class="px-6 py-2.5 bg-brand-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 flex items-center gap-2 transition-transform active:scale-95">
                    <i class="ph-bold ph-floppy-disk"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<div id="destination-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeDestinationModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden modal-enter flex flex-col h-[80vh]">

        <div class="p-6 border-b border-slate-200 bg-white shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-slate-900">Select Visa Destination</h3>
                <button onclick="closeDestinationModal()"
                    class="p-1 hover:bg-slate-100 rounded-full transition-colors text-slate-500 hover:text-slate-800">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="relative group">
                <i
                    class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                <input type="text" id="dest-search" onkeyup="filterDestinations()"
                    placeholder="Search Country (e.g. France, Turkey)..."
                    class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none transition-all shadow-sm">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 bg-slate-50 relative">

            <div id="dest-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>

            <div id="dest-loading"
                class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-50/80 z-10">
                <i class="ph-bold ph-spinner animate-spin text-3xl text-brand-500 mb-2"></i>
                <p class="text-slate-500 text-sm font-medium">Loading available visas...</p>
            </div>

            <div id="dest-empty" class="hidden flex flex-col items-center justify-center py-12 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <i class="ph-duotone ph-airplane-tilt text-3xl"></i>
                </div>
                <p class="text-sm font-medium">No destinations found matching your search.</p>
            </div>
        </div>

        <div
            class="p-4 border-t border-slate-200 bg-white flex justify-between items-center text-sm text-slate-500 shrink-0">
            <span id="dest-count-display" class="font-medium">Showing 0 destinations</span>
            <div class="flex gap-2">
                <button id="btn-prev" onclick="changePage(-1)" disabled
                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Previous</button>
                <button id="btn-next" onclick="changePage(1)" disabled
                    class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium">Next</button>
            </div>
        </div>
    </div>
</div>

<div id="manual-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeManualModal()">
    </div>

    <div
        class="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden modal-enter">

        <div class="bg-brand-600 p-4 flex justify-between items-center text-white shrink-0 shadow-md z-10">
            <div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] uppercase font-bold text-brand-200 tracking-wider">New Application</span>
                    <span id="display-form-version"
                        class="bg-brand-700 text-[10px] px-1.5 rounded text-white font-mono opacity-80">v--</span>
                </div>
                <h3 class="font-bold text-lg flex items-center gap-2 mt-0.5" id="selected-dest-title">
                    <i class="ph-fill ph-airplane-tilt"></i> Loading...
                </h3>
            </div>
            <button onclick="closeManualModal()"
                class="text-brand-100 hover:text-white p-1 rounded hover:bg-brand-500 transition-colors">
                <i class="ph-bold ph-x text-lg"></i>
            </button>
        </div>

        <form id="create-visa-form" method="POST" action="{% url 'visa_create' %}" enctype="multipart/form-data"
            class="flex-1 flex flex-col overflow-hidden">
            {% csrf_token %}
            <input type="hidden" id="hidden-dest-id" name="destination">

            <div class="flex-1 overflow-y-auto p-8 space-y-8 bg-slate-50/50">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-5 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h4 class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-2">1.
                            Applicant Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">First Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="first_name" required
                                    class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Last Name <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="last_name" required
                                    class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-500 transition-all">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Passport Number <span
                                    class="text-red-500">*</span></label>
                            <input type="text" name="passport_number" required
                                class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono uppercase focus:ring-2 focus:ring-brand-500 transition-all">
                        </div>
                        <div class="relative group">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign Agency</label>

                            <input type="hidden" id="real-agency-id" name="agency" value="">

                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="agency-search-input"
                                    placeholder="Search Agency or 'Direct Client'..." oninput="filterAgencies()"
                                    onfocus="showAgencyDropdown()"
                                    class="w-full pl-10 pr-8 py-2.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-slate-50 focus:bg-white transition-colors"
                                    autocomplete="off">

                                <button type="button" onclick="selectAgency('', 'Direct Client (Walk-in)')"
                                    class="absolute right-2 top-2 text-slate-400 hover:text-slate-600 p-1"
                                    title="Reset to Direct Client">
                                    <i class="ph-bold ph-x-circle"></i>
                                </button>
                            </div>

                            <div id="agency-dropdown-list"
                                class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-xl max-h-60 overflow-y-auto z-50 divide-y divide-slate-50">

                                <div id="agency-list-container"></div>

                                <div id="agency-loading" class="hidden p-4 text-center text-slate-400">
                                    <i class="ph-bold ph-spinner animate-spin"></i> Loading...
                                </div>

                                <div id="no-agencies-found"
                                    class="hidden p-4 text-center text-xs text-slate-400 italic">
                                    No agencies found.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="schema-loading"
                        class="hidden flex flex-col items-center justify-center h-full text-center p-8">
                        <i class="ph-bold ph-spinner animate-spin text-3xl text-brand-500 mb-3"></i>
                        <p class="text-sm font-bold text-slate-500">Retrieving latest form requirements...</p>
                    </div>

                    <div id="docs-section"
                        class="hidden space-y-5 bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                        <h4
                            class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-2 flex items-center gap-2">
                            <i class="ph-bold ph-files"></i> 2. Required Documents
                        </h4>
                        <div id="dynamic-docs-container" class="space-y-4"></div>
                    </div>
                </div>

                <div id="fields-section"
                    class="hidden bg-white p-6 rounded-xl border border-slate-200 shadow-sm animate-fade-in">
                    <h4
                        class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100 pb-3 mb-4 flex items-center gap-2">
                        <i class="ph-bold ph-list-dashes"></i> 3. Visa Application Form
                    </h4>
                    <div class="overflow-hidden rounded-lg border border-slate-100">
                        <table class="w-full text-left text-sm">
                            <thead
                                class="bg-slate-50 text-xs text-slate-500 font-semibold uppercase border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-3 w-1/3">Question</th>
                                    <th class="px-6 py-3 w-2/3">Applicant Answer</th>
                                </tr>
                            </thead>
                            <tbody id="dynamic-fields-container" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-slate-200 flex justify-between items-center shrink-0 z-10">
                <button type="button" onclick="backToDestinations()"
                    class="text-sm font-bold text-slate-500 hover:text-slate-700 flex items-center gap-1 group">
                    <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Change
                    Destination
                </button>
                <div class="flex gap-3">
                    <button type="button" onclick="closeManualModal()"
                        class="px-5 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 transition-colors">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold shadow-md hover:bg-brand-700 hover:-translate-y-0.5 transition-all flex items-center gap-2">
                        <i class="ph-bold ph-paper-plane-right"></i> Submit Application
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // ==========================================
    // 1. DASHBOARD & FILTER LOGIC (AJAX)
    // ==========================================
    let currentPage = 1;
    let currentStatus = 'all';
    let debounceTimer;

    // Load Data on Page Ready
    document.addEventListener("DOMContentLoaded", () => {
        loadAdminData();
        loadDestinationsFilter();
    });

    // --- MAIN LOADER ---
    function loadAdminData() {
        const search = document.getElementById('admin-search').value || '';
        const destSelect = document.getElementById('filter-destination');
        const dest = destSelect ? destSelect.value : '';
        const tbody = document.getElementById('admin-table-body');

        // === FIXED URL PATH ===
        const url = `/admin_panel/api/list/?page=${currentPage}&search=${search}&status=${currentStatus}&destination=${dest}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                // A. Update Stats Cards (Safely check if elements exist)
                if (data.stats) {
                    if (document.getElementById('stat-new')) document.getElementById('stat-new').innerText = data.stats.new;
                    if (document.getElementById('stat-review')) document.getElementById('stat-review').innerText = data.stats.review;
                    if (document.getElementById('stat-appt')) document.getElementById('stat-appt').innerText = data.stats.appt;
                    if (document.getElementById('stat-embassy')) document.getElementById('stat-embassy').innerText = data.stats.embassy;
                    if (document.getElementById('stat-ready')) document.getElementById('stat-ready').innerText = data.stats.ready;
                    if (document.getElementById('stat-completed')) document.getElementById('stat-completed').innerText = data.stats.completed;
                    if (document.getElementById('stat-rejected')) document.getElementById('stat-rejected').innerText = data.stats.rejected;
                    if (document.getElementById('stat-cancelled')) document.getElementById('stat-cancelled').innerText = data.stats.cancelled;
                }

                // B. Render Table Rows
                tbody.innerHTML = '';
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 italic">No applications found matching criteria.</td></tr>';
                    return;
                }

                data.data.forEach(app => {
                    // Logic for Agency Name
                    const agencyDisplay = app.agency === 'Direct Client'
                        ? `<span class="text-slate-400 italic">Direct Client</span>`
                        : app.agency;

                    // Logic for Apply By (Safe Fallback)
                    // We check if apply_by exists, otherwise default to 'System'
                    const applyBy = app.apply_by || 'System';

                    // Logic for Flag Image
                    const imgHtml = app.cover_image
                        ? `<img src="${app.cover_image}" class="w-6 h-4 object-cover rounded shadow-sm">`
                        : `<div class="w-6 h-4 bg-slate-200 rounded flex items-center justify-center text-[8px]">üè≥Ô∏è</div>`;

                    const row = `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="font-mono font-bold text-brand-600">
                                    #${app.reference}
                                </div>
                                <div class="text-xs text-slate-500">
                                    ${new Date(app.created_at).toLocaleString('en-GB')}
                                </div>
                            </td>

                            <td class="px-6 py-4">
                                <div class="font-medium text-slate-900">${app.applicant}</div>
                                <div class="text-xs text-slate-500 font-mono">${app.passport}</div>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <div class="font-medium">${agencyDisplay}</div>
                                <div class="text-xs text-slate-400 mt-1 flex items-center gap-1">
                                    <i class="ph-bold ph-user"></i> ${applyBy}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    ${imgHtml}
                                    <span>${app.country} - ${app.visa_type}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                ${getStatusBadge(app.status, app.status_label)}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="openProcessModal('${app.id}')" 
                                    class="bg-brand-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow hover:bg-brand-700 transition-colors">
                                    Process
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // C. Update Pagination Info
                const pageInfo = document.getElementById('page-info'); // Ensure ID exists in HTML
                if (pageInfo) {
                    pageInfo.innerHTML = `Showing page <span class="font-bold text-slate-900">${data.pagination.current_page}</span> of <span class="font-bold text-slate-900">${data.pagination.total_pages}</span>`;
                }

                // Disable/Enable buttons
                const btnPrev = document.getElementById('btn-prev');
                const btnNext = document.getElementById('btn-next');
                if (btnPrev) btnPrev.disabled = !data.pagination.has_previous;
                if (btnNext) btnNext.disabled = !data.pagination.has_next;

            })
            .catch(err => {
                console.error("Error loading data:", err);
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Error loading data.</td></tr>';
            });
    }

    // --- ACTIONS ---
    function setFilterStatus(status) {
        currentStatus = status;
        currentPage = 1;

        // Highlight Active Card
        document.querySelectorAll('.stat-card').forEach(c => {
            c.classList.remove('ring-2', 'ring-brand-500', 'bg-slate-50');
            if (c.id === `card-${status}`) c.classList.add('ring-2', 'ring-brand-500', 'bg-slate-50');
        });

        loadAdminData();
    }

    function changePage(d) {
        currentPage += d;
        loadAdminData();
    }

    function debounceLoad() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 1;
            loadAdminData();
        }, 500);
    }

    // --- HELPERS ---
    function getStatusBadge(status, label) {
        const styles = {
            'new': 'bg-blue-100 text-blue-700',
            'review': 'bg-yellow-100 text-yellow-700',
            'appointment': 'bg-purple-100 text-purple-700',
            'embassy': 'bg-orange-100 text-orange-700',
            'ready': 'bg-teal-100 text-teal-700',
            'completed': 'bg-green-100 text-green-700',
            'rejected': 'bg-red-100 text-red-700',
            'cancelled': 'bg-slate-100 text-slate-700'
        };
        const css = styles[status] || 'bg-slate-100 text-slate-600';
        return `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${css}">${label}</span>`;
    }

    // --- DESTINATIONS DROPDOWN ---
    function loadDestinationsFilter() {
        const select = document.getElementById('filter-destination');
        if (!select) return;

        // Ensure this URL tag is correct in your Django template
        fetch("{% url 'api_all_destinations' %}")
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    select.innerHTML = '<option value="">Filter by Destination</option>';
                    data.destinations.forEach(dest => {
                        const option = document.createElement('option');
                        option.value = dest.id;
                        option.text = `${dest.country} - ${dest.visa_type}`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(err => console.error("Failed to load destinations filter:", err));
    }
</script>

<script>
    // ==========================================
    // 2. PROCESS MODAL LOGIC
    // ==========================================
    const processModal = document.getElementById('process-modal');
    const statusSelect = document.getElementById('status-select');
    const fieldAppt = document.getElementById('field-appointment');
    const status_badge = document.getElementById('view-status-badge');

    // Labels & Colors for the Badge inside the modal
    const STATUS_LABELS = { new: "New Application", review: "Under Review", appointment: "Appointment Scheduled", embassy: "Submitted to Embassy", ready: "Ready for Collection", completed: "Completed", rejected: "Rejected" };
    const STATUS_COLORS = { new: "bg-blue-100 text-blue-600", review: "bg-yellow-100 text-yellow-600", appointment: "bg-purple-100 text-purple-600", embassy: "bg-orange-100 text-orange-600", ready: "bg-green-100 text-green-600", completed: "bg-indigo-100 text-indigo-600", rejected: "bg-red-100 text-red-600" };

    function openProcessModal(appId) {
        processModal.classList.remove('hidden');
        document.getElementById('view-ref').innerText = 'LOADING...';

        // Use existing API to fetch details
        fetch(`/admin_panel/api/visa/${appId}/`)
            .then(res => res.json())
            .then(data => populateModalData(data))
            .catch(err => {
                console.error(err);
                alert("Failed to load details.");
                closeProcessModal();
            });
    }

    function populateModalData(data) {
        document.getElementById('process-id').value = data.id;
        document.getElementById('view-ref').innerText = '#' + data.reference;
        document.getElementById('view-applicant').innerText = data.applicant;
        document.getElementById('view-agency').innerText = data.agency_name || 'Direct Client';
        document.getElementById('view-destination').innerText = data.destination || '-';
        document.getElementById('view-master-agent').textContent = data.user_admin || '-';
        document.getElementById("view-applied-by").textContent = data.apply_by || '-';



        // Set Select Value
        if (statusSelect.querySelector(`option[value="${data.status}"]`)) {
            statusSelect.value = data.status;
        }

        updateStatusBadge(data.status);
        // --- VISA DOC BADGE LOGIC (NEW) ---
        const visaBadge = document.getElementById('existing-visa-badge');
        const visaLink = document.getElementById('existing-visa-link');

        // Check if the API returned a document URL
        // Ensure your API sends 'visa_document_url' or adjust this key
        if (data.visa_document_url) {
            visaBadge.classList.remove('hidden');
            visaLink.href = data.visa_document_url;
        } else {
            visaBadge.classList.add('hidden');
        }
        toggleFields();

        // Bind Change Event for live badge update
        statusSelect.onchange = () => {
            updateStatusBadge(statusSelect.value);
            toggleFields();
        };

        // Fill Notes & Date
        document.getElementById('process-notes').value = data.admin_notes || '';
        document.getElementById('process-appt-date').value = data.appointment_date || '';

        // Render Answers
        const tableBody = document.getElementById('answers-table-body');
        tableBody.innerHTML = '';
        if (data.answers?.length) {
            data.answers.forEach(ans => {
                tableBody.insertAdjacentHTML('beforeend', `<tr class="hover:bg-slate-50"><td class="px-4 py-3 text-slate-600 font-medium border-b border-slate-100">${ans.label}</td><td class="px-4 py-3 font-bold text-slate-900 border-b border-slate-100">${ans.value}</td></tr>`);
            });
        } else {
            tableBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400 italic">No answers data.</td></tr>';
        }

        // Render Documents
        const docsContainer = document.getElementById('documents-list');
        docsContainer.innerHTML = '';
        if (data.documents?.length) {
            data.documents.forEach(doc => {
                let color = doc.status === 'rejected' ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600';
                docsContainer.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-3 border rounded-lg bg-white shadow-sm">
                        <div class="flex gap-3 items-center">
                            <div class="w-10 h-10 flex items-center justify-center rounded-lg ${color}"><i class="ph-fill ph-file-pdf text-lg"></i></div>
                            <div><p class="text-xs font-bold text-slate-700">${doc.name}</p></div>
                        </div>
                        <a href="${doc.url}" target="_blank" class="p-2 text-slate-500 hover:text-brand-600 bg-slate-50 rounded-lg"><i class="ph-bold ph-eye"></i></a>
                    </div>`);
            });
        } else {
            docsContainer.innerHTML = '<div class="text-center text-slate-400 text-sm italic">No documents.</div>';
        }
    }

    function saveProcessChanges() {
        const btn = document.querySelector('#process-modal button[onclick="saveProcessChanges()"]');
        const form = document.getElementById('process-form');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
        btn.disabled = true;

        const formData = new FormData(form);

        fetch("{% url 'api_visa_update' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("Updated Successfully!");
                    closeProcessModal();
                    loadAdminData(); // <--- REFRESH THE TABLE WITHOUT RELOAD
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => alert("Connection error"))
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function closeProcessModal() { processModal.classList.add('hidden'); }
    function toggleFields() {
        const val = statusSelect.value;

        // 1. Handle Appointment Field
        // Shows only when status is 'appointment'
        if (val === 'appointment') {
            fieldAppt.classList.remove('hidden');
        } else {
            fieldAppt.classList.add('hidden');
        }

        // 2. Handle Visa Upload Field (New)
        // Shows when status is 'ready' or 'completed'
        const visaField = document.getElementById('field-visa-upload');
        if (visaField) { // Check if element exists to avoid errors
            if (val === 'ready' || val === 'completed') {
                visaField.classList.remove('hidden');
            } else {
                visaField.classList.add('hidden');
            }
        }
    } function updateStatusBadge(status) {
        status_badge.className = `inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold mt-1 ${STATUS_COLORS[status] || 'bg-slate-100 text-slate-600'}`;
        status_badge.textContent = STATUS_LABELS[status] || status;
    }
</script>

<script>
    // ==========================================
    // 3. MANUAL APP & DESTINATION LOGIC (Preserved)
    // ==========================================
    let allDestinations = [];
    let filteredDestinations = [];
    let agenciesLoaded = false;
    const itemsPerPage = 6;

    const destModal = document.getElementById('destination-modal');
    const manualModal = document.getElementById('manual-modal');
    const destGrid = document.getElementById('dest-grid');
    const destLoading = document.getElementById('dest-loading');
    const destEmpty = document.getElementById('dest-empty');

    function openManualModal() {
        destModal.classList.remove('hidden');
        if (allDestinations.length === 0) {
            destLoading.classList.remove('hidden');
            fetch("{% url 'api_visa_destinations' %}")
                .then(res => res.json())
                .then(data => {
                    allDestinations = data.destinations;
                    filteredDestinations = [...allDestinations];
                    renderDestinations();
                })
                .finally(() => destLoading.classList.add('hidden'));
        }
    }

    function closeDestinationModal() { destModal.classList.add('hidden'); }
    function closeManualModal() { manualModal.classList.add('hidden'); }
    function backToDestinations() { closeManualModal(); openManualModal(); }

    function filterDestinations() {
        const query = document.getElementById('dest-search').value.toLowerCase();
        filteredDestinations = allDestinations.filter(d => d.country.toLowerCase().includes(query) || d.visa_type.toLowerCase().includes(query));
        renderDestinations();
    }

    function renderDestinations() {
        destGrid.innerHTML = '';
        if (filteredDestinations.length === 0) {
            destEmpty.classList.remove('hidden'); return;
        }
        destEmpty.classList.add('hidden');

        filteredDestinations.slice(0, 50).forEach(dest => { // Show first 50 to avoid lag
            destGrid.insertAdjacentHTML('beforeend', `
                <div onclick="selectDestination(${dest.id}, '${dest.country}', '${dest.visa_type}')" 
                     class="group bg-white border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-brand-500 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">üè≥Ô∏è</div>
                            <div><h4 class="font-bold text-slate-900">${dest.country}</h4><p class="text-xs text-slate-500">${dest.visa_type}</p></div>
                        </div>
                        <span class="bg-slate-100 text-slate-700 text-xs font-bold px-2.5 py-1 rounded">DZD ${dest.selling_price}</span>
                    </div>
                </div>`);
        });
    }

    function selectDestination(id, country, type) {
        closeDestinationModal();
        manualModal.classList.remove('hidden');
        document.getElementById('selected-dest-title').innerHTML = `${country} <span class="opacity-50 mx-2">|</span> ${type}`;
        document.getElementById('hidden-dest-id').value = id;
        loadVisaSchema(id);
    }

    function loadVisaSchema(destId) {
        document.getElementById('schema-loading').classList.remove('hidden');
        document.getElementById('fields-section').classList.add('hidden');
        document.getElementById('docs-section').classList.add('hidden');

        fetch(`/admin_panel/api/visa/schema/${destId}/`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('display-form-version').innerText = data.form_version;

                // Fields
                const fc = document.getElementById('dynamic-fields-container');
                fc.innerHTML = '';
                if (data.fields.length) {
                    data.fields.forEach(f => {
                        let html = `<input type="text" name="field_${f.id}" class="w-full border border-slate-300 rounded p-2 text-sm">`;
                        if (f.type === 'select') {
                            const ops = f.options.map(o => `<option>${o}</option>`).join('');
                            html = `<select name="field_${f.id}" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="">Select...</option>${ops}</select>`;
                        } else if (f.type === 'date') {
                            html = `<input type="date" name="field_${f.id}" class="w-full border border-slate-300 rounded p-2 text-sm">`;
                        } else if (f.type === 'checkbox') {
                            html = `<label class="flex gap-2"><input type="checkbox" name="field_${f.id}" value="Yes"> Yes</label>`;
                        }
                        fc.insertAdjacentHTML('beforeend', `<tr><td class="px-6 py-3 w-1/3 text-sm font-medium text-slate-700">${f.label}</td><td class="px-6 py-3 w-2/3">${html}</td></tr>`);
                    });
                    document.getElementById('fields-section').classList.remove('hidden');
                }

                // Docs
                const dc = document.getElementById('dynamic-docs-container');
                dc.innerHTML = '';
                if (data.documents.length) {
                    data.documents.forEach(d => {
                        dc.insertAdjacentHTML('beforeend', `
                            <div class="flex justify-between items-center p-3 border rounded bg-slate-50">
                                <div><p class="text-sm font-bold">${d.name}</p><p class="text-xs text-slate-500">${d.description || 'Required'}</p></div>
                                <input type="file" name="doc_${d.id}" class="text-xs">
                            </div>`);
                    });
                    document.getElementById('docs-section').classList.remove('hidden');
                }
            })
            .finally(() => document.getElementById('schema-loading').classList.add('hidden'));
    }

    // ==========================================
    // 5. AGENCY SEARCH LOGIC (Server-Side AJAX)
    // ==========================================

    let agencySearchTimer;
    const agencyDropdown = document.getElementById('agency-dropdown-list');
    const agencyContainer = document.getElementById('agency-list-container');
    const agencyLoading = document.getElementById('agency-loading');
    const agencyInput = document.getElementById('agency-search-input');
    const realAgencyInput = document.getElementById('real-agency-id');

    // 1. Show Dropdown & Load Default
    function showAgencyDropdown() {
        agencyDropdown.classList.remove('hidden');
        // If input is empty, fetch default list (first 20)
        if (agencyInput.value.trim() === '') {
            fetchAgencies('');
        }
    }

    // 2. Filter Function (Triggered by onkeyup/oninput)
    function filterAgencies() {
        clearTimeout(agencySearchTimer);
        const query = agencyInput.value;

        // Debounce: Wait 300ms after user stops typing
        agencySearchTimer = setTimeout(() => {
            fetchAgencies(query);
        }, 300);
    }

    // 3. Fetch Data from Server
    function fetchAgencies(query) {
        agencyLoading.classList.remove('hidden');
        agencyContainer.innerHTML = ''; // Clear previous results

        // Use the new API Endpoint
        fetch(`{% url 'api_agency_search' %}?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data.agencies.length === 0) {
                    agencyContainer.innerHTML = `<div class="p-4 text-center text-xs text-slate-400 italic">No agencies found matching "${query}".</div>`;
                } else {
                    renderAgencies(data.agencies);
                }
            })
            .catch(err => {
                console.error("Search Error:", err);
                agencyContainer.innerHTML = `<div class="p-2 text-center text-red-500 text-xs">Error loading data</div>`;
            })
            .finally(() => {
                agencyLoading.classList.add('hidden');
            });
    }

    // 4. Render HTML
    function renderAgencies(list) {
        const html = list.map(agency => `
            <div onclick="selectAgency('${agency.id}', '${agency.company_name.replace(/'/g, "\\'")}')" 
                 class="agency-option p-3 hover:bg-brand-50 cursor-pointer flex items-center gap-3 transition-colors border-b border-slate-50 last:border-0">
                <div class="w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 shrink-0">
                    <i class="ph-fill ph-buildings"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-slate-700">${agency.company_name}</p>
                    <p class="text-[10px] text-slate-400">Balance: DZD ${parseFloat(agency.current_balance).toLocaleString()}</p>
                </div>
            </div>
        `).join('');

        agencyContainer.innerHTML = html;
    }

    // 5. Select Logic
    function selectAgency(id, name) {
        realAgencyInput.value = id;
        agencyInput.value = name;
        agencyDropdown.classList.add('hidden');

        // Visual Feedback
        if (id) {
            agencyInput.classList.add('border-brand-500', 'bg-brand-50/50');
            agencyInput.classList.remove('border-slate-300', 'bg-slate-50');
        } else {
            // Direct Client (Reset)
            agencyInput.classList.remove('border-brand-500', 'bg-brand-50/50');
            agencyInput.classList.add('border-slate-300', 'bg-slate-50');
        }
    }

    // Close on click outside
    window.addEventListener('click', function (e) {
        const wrapper = agencyInput.closest('.group');
        if (!wrapper.contains(e.target)) {
            agencyDropdown.classList.add('hidden');
        }
    });

    // Form Submit
    document.getElementById('create-visa-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const btn = e.submitter;
        btn.disabled = true;
        btn.innerHTML = 'Saving...';

        const payload = {
            main_info: {
                first_name: this.querySelector('[name="first_name"]').value,
                last_name: this.querySelector('[name="last_name"]').value,
                passport_number: this.querySelector('[name="passport_number"]').value,
                destination: document.getElementById('hidden-dest-id').value,
                agency_id: parseInt(document.getElementById('real-agency-id').value) || null
            },
            answers: []
        };

        this.querySelectorAll('[name^="field_"]').forEach(i => {
            let val = i.type === 'checkbox' ? (i.checked ? 'Yes' : 'No') : i.value;
            payload.answers.push({ field_id: i.name.split('_')[1], value: val });
        });

        const formData = new FormData();
        formData.append('json_data', JSON.stringify(payload));
        this.querySelectorAll('input[type="file"]').forEach(i => {
            if (i.files.length) formData.append(i.name, i.files[0]);
        });

        fetch("{% url 'visa_create' %}", {
            method: 'POST', body: formData, headers: { "X-CSRFToken": "{{ csrf_token }}" }
        }).then(res => res.json()).then(d => {
            if (d.status === 'success') {
                alert("Created!");
                closeManualModal();
                loadAdminData(); // Refresh main table
            } else {
                alert("Error: " + d.message);
            }
        }).finally(() => { btn.disabled = false; btn.innerHTML = 'Submit Application'; });
    });
</script>

<!-- visa doc -->
<script>
    function toggleFields() {
        const val = document.getElementById('status-select').value;
        const apptField = document.getElementById('field-appointment');
        const visaField = document.getElementById('field-visa-upload');

        // 1. Appointment Logic
        if (val === 'appointment') {
            apptField.classList.remove('hidden');
        } else {
            apptField.classList.add('hidden');
        }

        // 2. Visa Upload Logic (Show if 'ready' or 'completed')
        if (val === 'ready' || val === 'completed') {
            visaField.classList.remove('hidden');
        } else {
            visaField.classList.add('hidden');
        }
    }
</script>
{% endblock %}